<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Academic Planner - Concordia MIAE</title>
    
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #fff; border-bottom: 1px solid #eee;">
        
        <div style="font-size: 15px; font-weight: bold; color: #e67e22; background: #fff3e0; padding: 6px 15px; border-radius: 20px; border: 1px solid #ffe0b2;">
            üëÅÔ∏è Viewing: <span id="displayViewingSid">{{ viewing_sid if viewing_sid else session.get('student_id', '') }}</span>
        </div>

        <div style="display: flex; align-items: center; gap: 20px;">
            {% if is_power_user %}
            <div style="position: relative;">
                <button onclick="openPendingModal()" style="background: #e74c3c; color: white; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    üì• Pending Approvals <span id="pendingBadge"></span>
                </button>
            </div>
            
            <div id="pendingModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:8px; box-shadow:0 10px 25px rgba(0,0,0,0.2); z-index:9999; width: 450px;">
                <h3 style="margin-top:0; color:#912338; display:flex; justify-content:space-between;">
                    Pending Approvals
                    <button onclick="openPendingModal(true)" style="font-size:12px; cursor:pointer; background:#eee; border:none; border-radius:4px; padding:4px 8px;">üîÑ Refresh</button>
                </h3>
                <ul id="pendingListUl" style="list-style:none; padding:0; max-height: 300px; overflow-y: auto;">
                    </ul>
                <button onclick="document.getElementById('pendingModal').style.display='none'" style="width: 100%; margin-top: 15px; padding: 8px; background: #ecf0f1; border: none; cursor: pointer; border-radius: 4px;">Close</button>
            </div>

            <div style="display: flex; align-items: center; gap: 8px; border: 1px solid #3498db; padding: 4px 10px; border-radius: 20px; background: #f0f7ff;">
                <span style="font-size: 11px; font-weight: bold; color: #2980b9;">ADMIN VIEW:</span>
                <input type="text" id="adminSidInput" placeholder="Student ID..." style="border: 1px solid #cbd5e0; border-radius: 15px; padding: 4px 10px; font-size: 12px; width: 110px; outline: none;" value="{{ viewing_sid if viewing_sid != session.get('student_id', '') else '' }}">
                <button onclick="adminSwitchStudent()" style="background: #3498db; color: white; border: none; padding: 4px 12px; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: bold;">Switch</button>
            </div>
            {% endif %}

            <span style="color: #2c3e50; font-size: 13px;">Logged in as: <b>{{ session.get('user_email') }}</b></span>

            <a href="#" onclick="handleLogout(event)" style="text-decoration: none; background: #e74c3c; color: white; padding: 6px 15px; border-radius: 15px; font-size: 13px; font-weight: bold; transition: background 0.3s;">Logout</a>
        </div>
    </div>
    <script>
        let idleTime = 0;
        function timerIncrement() {
            idleTime++;
            
            // --- NOU: 6 ore (360 min) pt Admini, 30 min pt Studen»õi ---
            {% if is_power_user %}
            let maxIdle = 360; 
            {% else %}
            let maxIdle = 30;  
            {% endif %}

            if (idleTime >= maxIdle) { 
                handleLogout(null, true); 
            }
        }
        setInterval(timerIncrement, 60000); // 1 minut
        document.onmousemove = document.onkeypress = document.onclick = document.ontouchstart = function() { idleTime = 0; };
    </script>


    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f8f9fa; color: #333; }
        .header-box { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid #912338; display: flex; align-items: center; position: relative; z-index: 10; margin-bottom: 15px; flex-wrap: wrap; gap: 20px;}
        .header-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; flex: 1; }

        select { padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; background-color: white; cursor: pointer; transition: all 0.2s; font-weight: 500;}
        select:focus { outline: none; box-shadow: 0 0 0 2px rgba(145, 35, 56, 0.3); }
        select.bg-fall { background-color: #912338; color: white; border-color: #912338; }
        select.bg-win { background-color: #3498db; color: white; border-color: #3498db; }
        select.bg-sum { background-color: #d35400; color: white; border-color: #d35400; }
        select option { background-color: white; color: #333; font-weight: normal; }

        .tools-container { background: #fff; border: 2px solid #dce4ec; border-left: 5px solid #912338; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden; transition: all 0.3s ease-in-out; position: relative; z-index: 9; margin: 0 20px 15px 20px;}
        .tools-header { background: #f8f9fa; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #333; font-size: 14px; user-select: none; border-bottom: 1px solid #eee; }
        .tools-header:hover { background: #f1f3f5; }
        .tools-content { padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; max-height: 500px; opacity: 1; transition: all 0.3s ease-in-out; background: #fff; }
        .tools-container.collapsed .tools-content { max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0; border-top: none;}
        
        .tool-group { display: flex; align-items: center; gap: 10px; background: #fcfcfc; padding: 8px 12px; border-radius: 4px; border: 1px solid #eee; flex-wrap: wrap;}
        .tool-label { font-size: 12px; font-weight: 600; color: #555; width: 160px; text-transform: uppercase; }
        .tool-group button { background: #fff; color: #333; border: 1px solid #ccc; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; transition: 0.2s; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
        .tool-group button:hover:not(:disabled) { background: #e9ecef; border-color: #b1bccc; }
        .btn-danger { color: #c0392b !important; border-color: #e6b0aa !important; background: #fdedec !important;}
        
        .btn-primary { background: #912338; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: auto;}
        .btn-primary:hover:not(:disabled) { background: #7a1d2f; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15);}
        .btn-primary:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }

        .layout-wrapper { display: flex; gap: 20px; visibility: hidden; padding: 0 20px 20px 20px; align-items: flex-start; }
        .main-content { flex: 3; display: flex; flex-direction: column; gap: 20px; min-width: 0; }
        
        .grid-box { background: #fff; padding: 5px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .validation-box { background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 5px solid #f39c12; }
        
        .sidebar { flex: 1; min-width: 280px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: sticky; top: 20px; max-height: 90vh; display: flex; flex-direction: column; }
        
        table { table-layout: fixed; width: 100%; border-collapse: collapse; margin: 0; }
        th, td { border: 1px solid #e9ecef; padding: 0; vertical-align: top; height: 1px; } 
        th { color: white; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; padding: 8px; border: none;}
        .th-year { background: #7f8c8d; width: 65px; border-top-left-radius: 6px; }
        .th-summer { background: #d35400; color: white; } 
        .th-fall { background: #912338; color: white; }   
        .th-winter { background: #3498db; color: white; border-top-right-radius: 6px; }
        
        .year-label { width: 65px; font-weight: bold; text-align: center; vertical-align: middle; background: #f8f9fa; color: #7f8c8d; border-right: 2px solid #e9ecef; }
        .year-subtext { display: block; font-size: 10px; font-weight: bold; color: #555; margin-top: 4px;}

        .term-container { display: flex; flex-direction: column; transition: all 0.3s; height: 100%;}
        .term-header { display: flex; justify-content: space-between; align-items: center; font-size: 10px; padding: 5px 6px; background: #fcfcfc; border-bottom: 1px solid #f0f0f0; color: #666; font-weight: 600; transition: background-color 0.2s;}
        .calc-cr { font-weight: bold; color: #912338; font-size: 11px;}
        .limit-group { display: flex; gap: 3px; align-items: center; }
        
        /* CSS CAZETE COOP ALBASTRE */
        .coop-header-info { background-color: #e1f5fe; border-bottom: 1px solid #b3e5fc; padding: 5px 6px; font-size: 11px; display: flex; flex-direction: column; gap: 2px; }
        .coop-label { color: #000; font-weight: 600; margin-bottom: 2px; }
        .coop-ws { color: #0277bd; font-weight: bold; text-transform: uppercase; }
        .coop-stats { color: #0277bd; font-weight: bold; font-size: 10px; }
        .coop-details { color: #333; margin-top: 3px; font-size: 10px; line-height: 1.2; font-style: italic; }

        .val-click { display: inline-block; min-width: 16px; text-align: center; background: #fff; border: 1px solid #ccc; border-radius: 3px; padding: 1px 4px; cursor: pointer; font-weight: bold; color: #912338; transition: 0.2s; }
        .val-click:hover { border-color: #912338; background: #fef5f6; }
        
        .limit-popup { position: absolute; background: white; border: 2px solid #912338; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9999; display: grid; padding: 6px; gap: 4px; grid-template-columns: repeat(3, 1fr); }
        .limit-popup div { padding: 6px 10px; cursor: pointer; font-size: 12px; font-weight: bold; text-align: center; border-radius: 4px; background: #f8f9fa; color: #333; transition: 0.2s; }
        .limit-popup div:hover { background: #912338; color: white; }

        .drop-zone { flex: 1; display: flex; flex-direction: column; min-height: 45px; background: #fff; padding: 6px; margin: 4px; border-radius: 4px; border: 1px dashed #ccc; transition: all 0.2s; }
        .drop-zone.dragover { background: #fef5f6; border: 2px dashed #912338; }
        
        .term-grayed .term-header { background-color: #e9ecef !important; color: #adb5bd !important; }
        .term-grayed .calc-cr, .term-grayed .limit-group { color: #adb5bd !important; }
        .term-grayed .val-click { background-color: transparent !important; color: #adb5bd !important; border-color: #dee2e6 !important; }
        .term-grayed .drop-zone { background-color: #f8f9fa !important; border-color: #dee2e6 !important; }
        .term-grayed .course-box:not(.wt) { opacity: 0.5; filter: grayscale(1); }

        .course-box { background: #fff; border: 1px solid #dce4ec; border-left: 4px solid #3498db; padding: 6px 8px; margin-bottom: 5px; border-radius: 4px; font-size: 11px; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1.4; transition: all 0.15s; position:relative;}
        .course-box.wt { border-left-color: #27ae60 !important; background-color: #d5f5e3 !important; font-weight: bold; z-index: 100; position: relative; }
        .course-box.ecp { border-left-color: #f1c40f; background: #fffdf0; }
        .course-box.invalid-term { background-color: #ffebee !important; border-color: #ef9a9a !important; border-left-color: #d32f2f !important; color: #b71c1c !important; }
        .course-box.selected { border-color: #912338; box-shadow: 0 0 0 2px rgba(145, 35, 56, 0.5); transform: scale(1.02); z-index: 5; position: relative;}
        
        .lock-checkbox { position: absolute; top: 2px; right: 2px; cursor: pointer; z-index: 10; width:12px; height:12px; accent-color:#912338; }

        .course-box.highlight-prereq { background-color: #fbc02d !important; border-color: #f57f17 !important; border-left-color: #f57f17 !important; color: #000; box-shadow: 0 0 8px rgba(245, 127, 23, 0.6); } 
        .course-box.highlight-coreq { background-color: #fff176 !important; border-color: #fbc02d !important; border-left-color: #fbc02d !important; color: #000; } 
        .course-box.highlight-postreq { background-color: #1976d2 !important; border-color: #0d47a1 !important; border-left-color: #0d47a1 !important; color: #fff; box-shadow: 0 0 8px rgba(13, 71, 161, 0.6); }
        .course-box.highlight-postcoreq { background-color: #64b5f6 !important; border-color: #1e88e5 !important; border-left-color: #1e88e5 !important; color: #fff;}
        
        .term-tag { display: inline-block; padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: bold; color: white; margin-right: 2px; text-transform: uppercase; }
        .tag-sum { background: #d35400; } .tag-fall { background: #912338; } .tag-win { background: #3498db; } .tag-any { background: #7f8c8d; }
        .course-meta { font-size: 9px; color: #666; display: block; margin-top: 2px; }
        
        #unallocatedZone { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; background: #fcfcfc; padding: 5px;}
        #courseInfoPanel { margin-top: 15px; padding: 15px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; font-size: 11px; color: #555; }
        #info_title { margin:0 0 10px 0; color:#912338; border-bottom:1px solid #ddd; padding-bottom:6px; font-size:13px; font-weight: 700;}
        .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .info-label { font-weight: 600; color: #777; }
        .info-val { color: #333; text-align: right; }
        
        #saveLoadGroup { margin-top:10px; display:flex; gap:10px; justify-content:center; }

        /* 1. Butoane Active */
        .tool-group button.btn-active {
            background-color: #912338 !important;
            color: white !important;
            border-color: #912338 !important;
            transform: scale(1.05); /* Le face putin mai mari sa iasa in evidenta */
            box-shadow: 0 4px 6px rgba(145, 35, 56, 0.3);
        }

        /* 2. Background Special pentru Institute WTs */
        .institute-wt-bg .coop-header-info {
            background-color: #34495e !important; 
            border-bottom: 2px solid #2c3e50 !important;
            box-shadow: inset 0 -2px 5px rgba(0,0,0,0.1);
        }

        .institute-wt-bg .coop-header-info .coop-label,
        .institute-wt-bg .coop-header-info .coop-ws,
        .institute-wt-bg .coop-header-info .coop-stats,
        .institute-wt-bg .coop-header-info .coop-details {
            color: #ffffff !important;
        }

        .institute-wt-bg .term-header {
            background-color: #fcfcfc !important; 
            color: #666 !important;
        }

        .institute-wt-bg .drop-zone {
            background-color: rgba(52, 73, 94, 0.04) !important; 
            border: 2px dashed #34495e !important; 
        }

        /* --- ECRAN DE INCARCARE (LOADING OVERLAY) --- */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            display: none; /* Ascuns by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px); /* Efect elegant de blur pe fundal */
        }
        
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- NOU: Delimitare orizontalƒÉ clarƒÉ √Æntre anii academici --- */
        #tableBody tr td {
            border-bottom: 4px dashed #aab7b8 !important; /* Linie √ÆntreruptƒÉ √Æntre ani */
        }
        
        #tableBody tr:first-child td {
            border-top: 4px solid #2c3e50 !important;
        }
        
        #tableBody tr:last-child td {
            border-bottom: 4px solid #2c3e50 !important;
        }
        /* --- NOU: Fundal galben discret pentru termenul curent --- */
        .current-term-highlight {
            background-color: #fffde7 !important; 
            border: 2px solid #fbc02d !important;
        }
        .current-term-highlight .term-header {
            background-color: #fff9c4 !important;
        }

        /* --- NOU: Text ro»ôu pentru cursurile cu erori --- */
        .course-box.error-text {
            border-color: #e74c3c !important;
            background-color: #fcf3f2 !important;
            border-left-color: #c0392b !important;
        }
        .course-box.error-text div {
            color: #c0392b !important;
        }
    </style>
</head>


<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <h2 style="color: #2c3e50; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Loading Student Data... ‚è≥</h2>
        <p style="color: #7f8c8d;">Please wait while the academic record is synchronized.</p>
    </div>

<div class="header-box">
    <div class="header-controls">
        <select id="programSelect" onchange="handleProgramChange()">
            <option value="">-- Select a Program --</option>
            {% for p in programe %}
                <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
        </select>
                
        <span style="font-weight: bold; color: #912338; font-size: 13px; margin-left: 10px;">Program Start:</span>
        <select id="startYear" onchange="handleStartYearChange()"></select>
        <select id="startTerm" onchange="handleStartTermChange()"><option value="Fall">Fall</option><option value="Winter">Winter</option></select>

        <div style="width: 1px; height: 25px; background: #ddd; margin: 0 10px;"></div>
        
        <label style="font-weight: bold; color: #912338; font-size: 13px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="coopRegistered" checked style="width: 16px; height: 16px; accent-color: #912338;" onchange="toggleCoopOptions()">
            CO-OP Registered
        </label>
        <div id="coopDetailsGroup" style="display: flex; gap: 5px; align-items: center;">
            <span style="font-size: 13px; color: #555;">Start:</span>
            <select id="coopStartYear" onchange="handleCoopChange()"></select>
            <select id="coopStartTerm" onchange="handleCoopChange()">
                <option value="SUM">Summer</option>
                <option value="FALL">Fall</option>
                <option value="WIN">Winter</option>
            </select>
        </div>
        
        <button onclick="saveSequence()" style="margin-left:auto; background:#27ae60; color:white; border:none; padding:8px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">üíæ Save</button>
        <button onclick="openLoadModal(true)" style="background:#3498db; color:white; border:none; padding:8px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">üìÇ Load</button>
    </div>
</div>

<div class="tools-container collapsed" id="toolsMenu">
    <div class="tools-header" onclick="toggleTools()"><span>üõ†Ô∏è Advanced Control Panel & Quick Actions</span><span>‚ñº</span></div>
    <div class="tools-content">
        <div class="tool-group">
            <button id="moveEcpBtn" style= "border-left-color: #f1c40f; background: #fffdf0; ">ALL ECP taken prior to Program</button>
            <button onclick="lockAllPlacedCourses()" style="background:#27ae60; color:white; border-color:#2ecc71; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">‚úÖ FIX in sequence all courses already placed</button>
            <button class="btn-danger" onclick="resetAllCourses()">Reset all unchecked to Unallocated</button>
        </div>
        <div class="tool-group"><select id="repeatCourseSelect" style="width: 250px; font-size: 11px;"><option value="" disabled selected>Select course to repeat...</option></select><button onclick="addRepeatCourse()">I need to repeat this course</button></div>

        <div class="tool-group">
            <span class="tool-label">Global Default Courses</span>
            <button onclick="setGlobalLimits('ct', 6, this)">6 Courses</button>
            <button class="btn-active" onclick="setGlobalLimits('ct', 5, this)">5 Courses</button>
            <button onclick="setGlobalLimits('ct', 4, this)">4 Courses</button>
            <button onclick="setGlobalLimits('ct', 3, this)" style="background:#fef5f6; border-color:#f5b7b1;">ACSD 3 Courses</button>
            <button onclick="setGlobalLimits('ct', 2, this)" style="background:#fef5f6; border-color:#f5b7b1;">ACSD 2 Courses</button>
            <span style="font-size: 10px; color:#888; margin-left:10px;">*Applies to Fall & Winter</span>
        </div>
        <div class="tool-group">
            <span class="tool-label">Global Default Credits</span>
            <button class="btn-active" onclick="setGlobalLimits('cr', 18, this)">18 Cr</button>
            <button onclick="setGlobalLimits('cr', 15, this)">15 Cr</button>
            <button onclick="setGlobalLimits('cr', 12, this)">12 Cr</button>
            <button onclick="setGlobalLimits('cr', 9, this)" style="background:#fef5f6; border-color:#f5b7b1;">ACSD 9 Cr</button>
            <button onclick="setGlobalLimits('cr', 6, this)" style="background:#fef5f6; border-color:#f5b7b1;">ACSD 6 Cr</button>
            <span style="font-size: 10px; color:#888; margin-left:10px;">*Applies to Fall & Winter</span>
        </div>
    </div>
</div>

<div style="margin: 0 20px 15px 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <button class="btn-primary" id="generateBtn" disabled>Generate Sequence</button>
    
    <div style="flex: 1; min-width: 300px;">
        <label style="font-size:11px; font-weight:bold; color:#27ae60;">üí¨ ADMIN comments (Visible to Student):</label>
        <textarea id="publicComments" 
            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" 
            {% if is_power_user %}
                onblur="autoSaveComments(this)"
            {% endif %}
            style="width: 100%; min-height: 40px; padding: 8px; border: 1px solid #27ae60; border-radius: 4px; font-family: inherit; resize: none; overflow: hidden; background: white; transition: background 0.3s;" 
            {% if not is_power_user %}readonly{% endif %}></textarea>
    </div>
    
    {% if is_power_user %}
    <div style="flex: 1; min-width: 300px;">
        <label style="font-size:11px; font-weight:bold; color:#c0392b;">üîí PRIVATE Comments (Admin Only):</label>
        <textarea id="privateComments" 
            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" 
            onblur="autoSaveComments(this)"
            style="width: 100%; min-height: 40px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px; font-family: inherit; resize: none; overflow: hidden; background: #fdedec; transition: background 0.3s;"></textarea>
    </div>
    
    <button onclick="processStatusAction('REWORK')" id="btnRework" style="display:none; background:#f39c12; color:white; border:none; padding:10px 20px; border-radius:4px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);">üîÑ REWORK</button>
    {% endif %}
</div>

<div class="layout-wrapper" id="workspace">
    <div class="main-content">
        <div class="grid-box">
            <table>
                <thead><tr><th class="th-year">Year</th><th class="th-summer">Summer</th><th class="th-fall">Fall</th><th class="th-winter">Winter</th></tr></thead>
                <tbody id="tableBody">
                    <tr><td class="year-label">Y 0 <span class="year-subtext" id="y0-label"></span></td>
                        <td colspan="3" style="padding: 8px;">
                            <div style="font-size: 11px; color: #7f8c8d; margin-bottom: 5px; font-weight: 600;">Exemptions & Transfer Credits (ECP)</div><div class="drop-zone" id="zone_Y0_ANY" data-term="Y0_ANY" ondrop="drop(event)" ondragover="allowDrop(event)" style="flex-direction: row; flex-wrap: wrap;"></div></td></tr>
                </tbody>
            </table>
        </div>
        
        

        
        <div id="submitPanel" style="margin-top: 40px; padding: 25px; background: #f8f9fa; border: 1px solid #dcdde1; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3 style="margin-top:0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                üéì Finalize & Submit Sequence
            </h3>
            <p style="color: #636e72; font-size: 14px;">Once your sequence is complete, submit it to the CO-OP AD Director for approval. If your sequence has validation warnings, you must provide a justification before submitting.</p>

            <div id="justificationBox" style="margin-bottom: 20px; background: #f9fff9; padding: 15px; border-left: 4px solid #27ae60; border-radius: 4px; transition: all 0.3s;">
                <label id="justificationLabel" style="font-weight: bold; color: #27ae60; display: block; margin-bottom: 8px;">üí¨ Sequence looks good! Comments are optional:</label>
                
                <textarea id="justificationText" 
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" 
                    style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-family: inherit; resize: none; overflow: hidden;" 
                    placeholder="Comments are optional: "></textarea>
                
                The sequnece will be emailed to:
                <li><b>MIAE Academic Director:</b> Dr. Sorin Voiculescu (coop_miae@concordia.ca)</li>
                <li><b>Undergrad Program Assistant:</b> Sabrina Poirier (sabrina.poirier@concordia.ca)</li>
                <li><b>Co-op Coordinator:</b> <span id="coopCoordName" style="font-weight: bold;">Loading...</span> (<span id="coopCoordEmail">...</span>)</li>
            </div>

            <button onclick="submitSequence()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background 0.3s;">
                üì§ Submit to CO-OP Director
            </button>
        </div>
        
        
        {% if is_power_user %}
            <div style="margin-top: 20px; padding: 15px; background: #e8f6f3; border: 1px solid #a3e4d7; border-radius: 8px;">
                <button onclick="processStatusAction('APPROVED')" id="btnApprove" style="display:none; width:100%; background:#27ae60; color:white; border:none; padding:12px; border-radius:4px; font-weight:bold; font-size:14px; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.1);">‚úÖ APPROVE SEQUENCE</button>
            </div>
        {% endif %}

 
    </div>
    
    <div class="sidebar" style="display: flex; flex-direction: column; max-height: 90vh;">
        
        <h4 style="margin: 0 0 10px 0; color: #912338; font-size: 14px; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; flex-shrink: 0;">Unallocated Courses</h4>
        <div class="drop-zone" id="unallocatedZone" ondrop="drop(event)" ondragover="allowDrop(event)" style="flex-grow: 1; overflow-y: auto; min-height: 150px;"></div>
        
        

        <div id="courseInfoPanel" style="display:none; margin-top: 15px; flex-shrink: 0; max-height: 30vh; overflow-y: auto;">
            <h5 id="info_title">Course Name</h5>
            <div class="info-row"><span class="info-label">Type:</span><span class="info-val" id="info_type">-</span></div>
            <div class="info-row"><span class="info-label">Credits:</span><span class="info-val" id="info_cr">-</span></div>
            <div class="info-row"><span class="info-label">Terms:</span><span class="info-val" id="info_terms" style="color:#3498db; font-weight:700">-</span></div>
            <div style="margin-top:10px; padding-top:8px; border-top:1px dashed #ccc;"><span class="info-label" style="color:#f57f17; font-size:10px;">PRE-REQUISITES:</span><p id="info_prereq" style="margin:2px 0 8px 0; color:#555; font-size:11px;">-</p><span class="info-label" style="color:#fbc02d; font-size:10px;">CO-REQUISITES:</span><p id="info_coreq" style="margin:2px 0; color:#555; font-size:11px;">-</p></div>
            <div style="margin-top:10px; padding-top:8px; border-top:1px dashed #ccc;"><span class="info-label" style="color:#0d47a1; font-size:10px;">IS PRE-REQ FOR:</span><p id="info_post_prereq" style="margin:2px 0 8px 0; color:#555; font-size:11px;">-</p><span class="info-label" style="color:#1e88e5; font-size:10px;">IS CO-REQ FOR:</span><p id="info_post_coreq" style="margin:2px 0; color:#555; font-size:11px;">-</p></div>
        </div>

        <div class="validation-box" id="liveValidationBox" style="margin-top: 15px; flex-shrink: 0; max-height: 20vh; display: flex; flex-direction: column;">
            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px; flex-shrink: 0;">Live Check 
                <span style="font-size:10px; color:#7f8c8d; font-weight:normal; float:right;">Updates automatically</span>
            </h4>
            <div style="overflow-y: auto; flex-grow: 1; padding-right: 5px;">
                <ul id="liveValidationList" style="margin: 0; padding-left: 15px; line-height: 1.5; font-size: 12px;">
                    <li style="color:#27ae60; font-weight:bold;">‚úÖ Sequence looks good!</li>
                </ul>
            </div>
        </div>

    </div>

</div>

<script>
    const programFtCredits = {{ program_ft_credits_json | safe }};
    let windowLoadedSeqTimestamp = null;

    let windowLoadedSeqTitle = "";
    let windowLoadedSeqRowIndex = null; 
    let currentPendingList = [];        
    let windowLoadedSeqEmail = ""; 
    
    let coursesData = {};
    let repeatedCoursesList = []; 
    let termAttributes = {};

    
    const programGpaThresholds = {{ program_gpa_thresholds_json | safe }}; 
    let studentCGPAData = {}; 
    let studentTermDisciplines = {}; 

    const serverCoopData = {{ coop_data_json | safe }};
    let studentCoopData = serverCoopData.found ? serverCoopData.terms : {}; 

    let defCrFW = 18, defCtFW = 5, defCrSum = 7, defCtSum = 2;

    document.addEventListener("DOMContentLoaded", () => {
        const currentYear = new Date().getFullYear();
        const startSelect = document.getElementById('startYear');
        
        for (let y = currentYear; y >= currentYear - 6; y--) { 
            startSelect.add(new Option(y, y)); 
        }
        
        if (serverCoopData.found && serverCoopData.admission) {
            const adm = serverCoopData.admission;
            if(!Array.from(startSelect.options).some(o => o.value == adm.year)) {
                startSelect.add(new Option(adm.year, adm.year));
            }
            startSelect.value = adm.year;
            document.getElementById('startTerm').value = adm.term.includes('FALL') ? "Fall" : "Winter";
        }

        updateCoopYears(); 
        updateAllSelectColors();
        fetchPendingCountSilently();
    });

    function getMaskedEmail(email) {
        if (!email || !email.includes('@')) return email;
        let parts = email.split('@');
        let name = parts[0];
        let domainFull = parts[1];
        
        let domainParts = domainFull.split('.');
        let tld = domainParts.pop(); 
        let host = domainParts.join('.'); 
        
        let maskedName = name.charAt(0) + "******";
        let maskedHost = host.charAt(0) + "***";
        
        return `${maskedName}@${maskedHost}.${tld}`;
    }

    async function handleLogout(e, isIdle = false) {
        if (e) e.preventDefault();
        
        {% if not is_power_user %}
        let loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
            loadingOverlay.querySelector('h2').innerText = isIdle ? "Idle Timeout. Saving data..." : "Saving sequence before log off...";
        }

        try {
            let seqData = {};
            let locks = [];
            document.querySelectorAll('td .drop-zone').forEach(z => {
                let termId = z.id.replace('zone_', '');
                seqData[termId] = Array.from(z.children).map(c => c.id);
                Array.from(z.children).forEach(el => {
                    if (coursesData[el.id] && coursesData[el.id].locked) locks.push(el.id);
                });
            });
            let unalloc = Array.from(document.getElementById('unallocatedZone').children).map(c => c.id);

            let sequence_data = {
                startYear: document.getElementById('startYear').value,
                startTerm: document.getElementById('startTerm').value,
                coop: document.getElementById('coopRegistered').checked,
                coopStartYear: document.getElementById('coopStartYear').value,
                coopStartTerm: document.getElementById('coopStartTerm').value,
                placed: seqData,
                unallocated: unalloc,
                locks: locks
            };

            let currentSid = "";
            let displayViewingSid = document.getElementById('displayViewingSid');
            if (displayViewingSid) currentSid = displayViewingSid.innerText.split('-')[0].trim();

            let payload = {
                name: "Auto-Saved on LogOff",
                program: document.getElementById('programSelect').value,
                student_id: currentSid,
                sequence_data: sequence_data,
                term_data: typeof termAttributes !== 'undefined' ? termAttributes : {},
                settings_data: {
                    startYear: document.getElementById('startYear').value,
                    coop: document.getElementById('coopRegistered').checked
                },
                status: "SAVED DRAFT",
                justification: document.getElementById('justificationText') ? document.getElementById('justificationText').value : "",
                student_comments: ""
            };

            await fetch('/save_sequence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } catch (err) {
            console.error("Auto-save on logout failed:", err);
        }
        {% endif %}

        window.location.href = '/logout';
    }
    
    function injectCoopHeaders() {
        if (!studentCoopData || Object.keys(studentCoopData).length === 0) return;

        const pYear = parseInt(document.getElementById('startYear').value), pTerm = document.getElementById('startTerm').value; 
        const baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;

        document.querySelectorAll('.coop-header-info').forEach(e => e.remove());
        document.querySelectorAll('.institute-wt-bg').forEach(el => el.classList.remove('institute-wt-bg'));

        for(let y=1; y<=7; y++) {
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                const container = document.getElementById(`cont_Y${y}_${t}`);
                if(!container) return;

                let realYear = 0;
                if (t === 'FALL') realYear = baseYear + y - 1;
                else if (t === 'WIN') realYear = baseYear + y;
                else if (t === 'SUM') realYear = baseYear + y - 1; 

                let info = studentCoopData[`${realYear}_${t}`];

                if (info) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'coop-header-info';
                    
                    let html = "";
                    let safeLabel = String(info.label || '').trim();
                    if(safeLabel && safeLabel.toLowerCase() !== 'nan') html += `<div class="coop-label">${safeLabel}</div>`;

                    let safeWs = String(info.ws || '').trim();
                    if(safeWs && safeWs.toLowerCase() !== 'nan') html += `<div class="coop-ws">${safeWs}</div>`;

                    let v = parseInt(info.views) || 0, a = parseInt(info.applied) || 0;
                    if(v > 0 || a > 0) html += `<div class="coop-stats">View: ${v} &nbsp; Applied: ${a}</div>`;

                    let safeDetails = String(info.details || '').trim();
                    if(safeDetails && safeDetails.toLowerCase() !== 'nan') html += `<div class="coop-details">&nbsp;&nbsp;&nbsp;${safeDetails}</div>`;
                    
                    let safeTw = String(info.tw_ok || '').trim();
                    if(safeTw && safeTw.toLowerCase() !== 'nan') html += `<div style="color:#c0392b; font-weight:bold; font-size:10px; margin-top:4px; border-top:1px solid #f5b7b1; padding-top:3px;">‚ö†Ô∏è Status: ${safeTw}</div>`;
                    
                    headerDiv.innerHTML = html;
                    container.insertBefore(headerDiv, container.firstChild);

                    if (safeWs.toUpperCase().includes('WT') || safeLabel.toUpperCase().includes('W-')) container.classList.add('institute-wt-bg');
                }
            });
        }
    }


    async function fetchPendingCountSilently() {
        let badge = document.getElementById('pendingBadge');
        if (!badge) return; 
        try {
            let res = await fetch('/api/pending_approvals');
            if (res.ok) {
                let data = await res.json();
                if (data.length > 0) {
                    badge.innerText = `(${data.length})`;
                } else {
                    badge.innerText = `(0)`;
                }
            }
        } catch (e) {
            console.log("Silent fetch for badge failed.");
        }
    }


    {% if is_power_user %}
    async function adminSwitchStudent() {
        const targetSid = document.getElementById('adminSidInput').value.trim();
        if (!targetSid) return;
        
        try {
            const res = await fetch('/admin_change_sid', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ target_sid: targetSid })
            });
            
            if (res.ok) {
                window.location.reload(); 
            } else {
                alert("Error switching student ID");
            }
        } catch (e) {
            console.error(e);
            alert("Connection error.");
        }

         autoDetectProgram();
    }


    {% endif %}

    async function saveSequence() {
        const now = new Date();
        const defaultName = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0') + " " + String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
        const name = prompt("Enter a name for this sequence:", defaultName);
        if(!name) return;
        
        let sequence_data = {
            startYear: document.getElementById('startYear').value,
            startTerm: document.getElementById('startTerm').value,
            coop: document.getElementById('coopRegistered').checked,
            coopStartYear: document.getElementById('coopStartYear').value,
            coopStartTerm: document.getElementById('coopStartTerm').value,
            placed: {}, unallocated: [], locks: [] 
        };
        
        document.querySelectorAll('td .drop-zone').forEach(z => {
            Array.from(z.children).forEach(el => {
                if(!sequence_data.placed[z.dataset.term]) sequence_data.placed[z.dataset.term] = [];
                sequence_data.placed[z.dataset.term].push(el.id);
                if(coursesData[el.id].locked) sequence_data.locks.push(el.id);
            });
        });
        
        Array.from(document.getElementById('unallocatedZone').children).forEach(el => {
            sequence_data.unallocated.push(el.id);
        });

        let currentSid = "";
        let displayViewingSid = document.getElementById('displayViewingSid');
        if (displayViewingSid) {
            currentSid = displayViewingSid.innerText.split('-')[0].trim();
        }

        try {
            const res = await fetch('/save_sequence', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name, 
                    program: document.getElementById('programSelect').value,
                    student_id: currentSid, 
                    sequence_data: sequence_data, 
                    term_data: termAttributes 
                })
            });
            if(res.ok) alert("Sequence saved to Google Drive!");
            else alert("Error saving sequence.");
        } catch(e) { console.error(e); alert("Save failed."); }
    }


    
    // AdaugƒÉ parametrul forceRefresh
    async function openLoadModal(forceRefresh = false) {
        let url = '/load_sequences';
        if (forceRefresh) url += '?refresh=true'; // NOU
        
        const res = await fetch(url);
        const data = await res.json();
        // ... restul codului rƒÉm√¢ne la fel
        coursesData = data; 
        
        if(data.sequences && data.sequences.length > 0) {
            let msg = "Available sequences:\n";
            data.sequences.forEach((s, i) => {
                let statusBadge = s.Status && s.Status.trim() !== "" ? ` [${s.Status}]` : "";
                msg += `${i+1}. ${s.Sequence_Name}${statusBadge}\n`;
            });
            let choice = prompt(msg + "\nEnter number to load (without '.', e.g. 3):");
            
            if(choice && data.sequences[choice-1]) {
                const selected = data.sequences[choice-1];
                
                let displaySidEl = document.getElementById('displayViewingSid');
                if (displaySidEl && selected.Student_ID) {
                    displaySidEl.innerText = selected.Student_Name ? `${selected.Student_ID} - ${selected.Student_Name}` : selected.Student_ID;
                }
                
                let currentSid = selected.Student_ID || (displaySidEl ? displaySidEl.innerText.split('-')[0].trim() : "");
                
                if (currentSid && currentSid !== "ADMIN") {
                    await fetchAndUpdateCoopData(currentSid); 
                    await fetchCGPAData(currentSid); 
                    fetchComments(currentSid);
                } else {
                    studentCoopData = {};
                    studentCGPAData = {}; 
                }
                
                await loadSequenceData(selected.JSON_Data, selected.Term_Data, selected.Settings_Data, selected.Program);
            }
        } else {
            alert("No saved sequences found.");
        }
    }

    async function loadSequenceData(seqData, termData, settingsData, programName) {
        document.getElementById('loadingOverlay').style.display = 'flex'; 
        try {
            termAttributes = termData || {}; 
            if (programName) {
                document.getElementById('programSelect').value = programName;
                document.getElementById('workspace').style.visibility = 'visible';
                document.getElementById('toolsMenu').classList.remove('collapsed');
                await fetchCoursesForProgram(programName);
            } else { alert("Cannot load: Program name missing."); return; }

            let sYear = seqData.startYear || (settingsData ? settingsData.startYear : null);
            let sTerm = seqData.startTerm || (settingsData ? settingsData.startTerm : "Fall");
            let isCoop = seqData.coop !== undefined ? seqData.coop : (settingsData && settingsData.coop !== undefined ? settingsData.coop : true);
            
            if (sYear) document.getElementById('startYear').value = sYear;
            if (sTerm) document.getElementById('startTerm').value = sTerm;
            document.getElementById('coopRegistered').checked = isCoop;
            toggleCoopOptions(); 
            if (seqData.coopStartYear) document.getElementById('coopStartYear').value = seqData.coopStartYear;
            if (seqData.coopStartTerm) document.getElementById('coopStartTerm').value = seqData.coopStartTerm;
            
            document.querySelectorAll('td .drop-zone').forEach(z => z.innerHTML = '');
            document.getElementById('unallocatedZone').innerHTML = '';
            buildGrid();
            await loadTranscriptAndMapInstitute();
            document.querySelectorAll('td .drop-zone').forEach(z => z.innerHTML = '');
            document.getElementById('unallocatedZone').innerHTML = '';

            let placedDict = seqData.placed || seqData; 
            let placedSet = new Set();
            Object.keys(placedDict).forEach(term => {
                let safeTerm = term.replace('_SUM1', '_SUM').replace('_SUM2', '_SUM');
                let zoneId = safeTerm.startsWith('zone_') ? safeTerm : `zone_${safeTerm}`;
                let zone = document.getElementById(zoneId);
                if(zone && Array.isArray(placedDict[term])) {
                    placedDict[term].forEach(cid => {
                        if(coursesData[cid]) {
                            coursesData[cid].locked = (seqData.locks && seqData.locks.includes(cid));
                            zone.appendChild(createCourseElement(cid));
                            placedSet.add(cid);
                        }
                    });
                }
            });
            
            if(seqData.unallocated) {
                seqData.unallocated.forEach(cid => {
                    if(coursesData[cid] && !placedSet.has(cid)) {
                        coursesData[cid].locked = false;
                        document.getElementById('unallocatedZone').appendChild(createCourseElement(cid));
                        placedSet.add(cid);
                    }
                });
            } else {
                Object.keys(coursesData).forEach(cid => {
                    if (!placedSet.has(cid)) document.getElementById('unallocatedZone').appendChild(createCourseElement(cid));
                });
            }
            
            document.querySelectorAll('.course-box.wt').forEach(box => { box.style.display = isCoop ? 'block' : 'none'; });
            updateRoutingInfo(); sortUnallocatedDOM(); enforceAndHighlightTerms(); updateCredits(); checkWT(); runLiveCheck();
        } catch (e) { console.error("Error loading sequence:", e); alert("Error loading sequence.");
        } finally { document.getElementById('loadingOverlay').style.display = 'none'; }
    }

    function sortUnallocatedDOM() {
        const u = document.getElementById('unallocatedZone');
        let items = Array.from(u.children);
        items.sort((a, b) => {
            let aIsWT = a.id.toUpperCase().includes('WT');
            let bIsWT = b.id.toUpperCase().includes('WT');
            if (aIsWT && !bIsWT) return -1;
            if (!aIsWT && bIsWT) return 1;
            
            let nameA = coursesData[a.id] ? coursesData[a.id].full_name : a.id;
            let nameB = coursesData[b.id] ? coursesData[b.id].full_name : b.id;
            
            return nameA.localeCompare(nameB);
        });
        u.innerHTML = '';
        items.forEach(item => u.appendChild(item));
    }

    function toggleLock(cid) {
        coursesData[cid].locked = !coursesData[cid].locked;
        let el = document.getElementById(cid);
        let newEl = createCourseElement(cid);
        el.parentNode.replaceChild(newEl, el);
    }

    function updateSelectColor(selectId) {
        const sel = document.getElementById(selectId);
        if(!sel) return;
        sel.classList.remove('bg-fall', 'bg-win', 'bg-sum');
        if(!sel.disabled) {
            const val = sel.value.toUpperCase();
            if (val.includes('FALL')) sel.classList.add('bg-fall');
            else if (val.includes('WIN')) sel.classList.add('bg-win');
            else if (val.includes('SUM')) sel.classList.add('bg-sum');
        }
    }
    function updateAllSelectColors() { updateSelectColor('startTerm'); updateSelectColor('coopStartTerm'); }

    function showLimitPopup(element, type, termStr) {
        document.querySelectorAll('.limit-popup').forEach(p => p.remove());
        const popup = document.createElement('div'); popup.className = 'limit-popup';
        let values = (type === 'cr') ? [0,3,6,9,12,15,18,21] : (termStr.includes('SUM') ? [0,1,2,3] : [0,1,2,3,4,5,6]);
        values.forEach(v => {
            const btn = document.createElement('div'); btn.innerText = v;
            btn.onclick = (e) => { e.stopPropagation(); element.innerText = v; element.dataset.userVal = v; popup.remove(); enforceAndHighlightTerms(); };
            popup.appendChild(btn);
        });
        document.body.appendChild(popup);
        const rect = element.getBoundingClientRect();
        popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        popup.style.left = (rect.left + window.scrollX - 10) + 'px';
        setTimeout(() => {
            const closer = (e) => { if (!popup.contains(e.target) && e.target !== element) { popup.remove(); window.removeEventListener('click', closer); } };
            window.addEventListener('click', closer);
        }, 10);
    }

    function populateRepeatSelect() {
        const sel = document.getElementById('repeatCourseSelect');
        sel.innerHTML = '<option value="" disabled selected>Select course to repeat...</option>';
        Object.keys(coursesData).sort((a,b) => coursesData[a].full_name.localeCompare(coursesData[b].full_name)).forEach(id => {
            if(!coursesData[id].is_ecp && !coursesData[id].is_wt && coursesData[id].type !== "REPEAT") sel.add(new Option(coursesData[id].full_name, id));
        });
    }

    function handleStartYearChange() { 
        const sYear = document.getElementById('startYear').value;
        if (document.getElementById('coopRegistered').checked) {
            updateCoopYears(); document.getElementById('coopStartYear').value = sYear; document.getElementById('coopStartTerm').value = "FALL";
        } else { updateCoopYears(); }
        updateAllSelectColors(); triggerGridRebuild(); 
    }

    function handleStartTermChange() {
        if (document.getElementById('coopRegistered').checked) { document.getElementById('coopStartYear').value = document.getElementById('startYear').value; document.getElementById('coopStartTerm').value = "FALL"; }
        resetAllCourses(); updateAllSelectColors(); triggerGridRebuild();
    }

    function handleCoopChange() { enforceCoopLogic(); updateAllSelectColors(); enforceAndHighlightTerms(); }

    function updateCoopYears() {
        const coopSelect = document.getElementById('coopStartYear'), startYear = parseInt(document.getElementById('startYear').value), currentYear = new Date().getFullYear();
        const prevSelected = coopSelect.value; coopSelect.innerHTML = '';
        for (let y = startYear; y <= currentYear + 2; y++) { coopSelect.add(new Option(y, y)); }
        if (prevSelected && prevSelected >= startYear && prevSelected <= currentYear + 2) coopSelect.value = prevSelected;
    }

    function toggleCoopOptions() {
        const isChecked = document.getElementById('coopRegistered').checked;
        document.getElementById('coopDetailsGroup').style.opacity = isChecked ? '1' : '0.4';
        document.getElementById('coopStartTerm').disabled = !isChecked; document.getElementById('coopStartYear').disabled = !isChecked;
        
        if(isChecked) {
            updateCoopYears(); 
            document.getElementById('coopStartYear').value = document.getElementById('startYear').value; 
            document.getElementById('coopStartTerm').value = "FALL";
        }
        
        updateAllSelectColors(); 
        
        const submitPanel = document.getElementById('submitPanel');
        if (submitPanel) {
            submitPanel.style.display = isChecked ? 'block' : 'none';
        }

        document.querySelectorAll('.course-box.wt').forEach(box => {
            if(!isChecked && box.parentElement && box.parentElement.id !== 'unallocatedZone') {
                document.getElementById('unallocatedZone').appendChild(box);
            }
            box.style.display = isChecked ? 'block' : 'none';
        });
        
        triggerGridRebuild();
    }

    function getTermScore(year, term) {
        if(term === 'WIN') return year * 10 + 1; 
        if(term === 'SUM' || term === 'SUM1' || term === 'SUM2') return year * 10 + 2; 
        if(term === 'FALL') return year * 10 + 4; 
        return 0;
    }

    function enforceCoopLogic() {
        const sYear = parseInt(document.getElementById('startYear').value), sTerm = document.getElementById('startTerm').value;
        const cYear = parseInt(document.getElementById('coopStartYear').value), cTerm = document.getElementById('coopStartTerm').value;
        if (getTermScore(cYear, cTerm) < getTermScore(sYear, sTerm === 'Fall' ? 'FALL' : 'WIN')) {
            document.getElementById('coopStartYear').value = sYear;
            document.getElementById('coopStartTerm').value = sTerm === 'Fall' ? 'FALL' : 'WIN';
        }
    }

    function setGlobalLimits(type, value, btnObj) {
        if(type === 'cr') defCrFW = value; if(type === 'ct') defCtFW = value;
        document.querySelectorAll(`.val-click.${type}-val`).forEach(span => { if(!span.id.includes('SUM')) delete span.dataset.userVal; });
        
        if (btnObj) {
            let parentGroup = btnObj.closest('.tool-group');
            if (parentGroup) {
                parentGroup.querySelectorAll('button').forEach(b => b.classList.remove('btn-active'));
            }
            btnObj.classList.add('btn-active');
        }
        
        enforceAndHighlightTerms();
    }

    function enforceAndHighlightTerms() {
        const pTerm = document.getElementById('startTerm').value, pYear = parseInt(document.getElementById('startYear').value);
        const baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;
        const startScore = getTermScore(pYear, pTerm === 'Fall' ? 'FALL' : 'WIN');
        document.getElementById('y0-label').innerText = `PRIOR to ${pTerm} ${pYear}`;

        for(let y=1; y<=7; y++) {
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let termStr = `Y${y}_${t}`, termYear = (t === 'WIN') ? (baseYear + y) : (baseYear + y - 1);
                let cellScore = getTermScore(termYear, t); 
                const crSpan = document.getElementById(`maxcr_${termStr}`), ctSpan = document.getElementById(`maxct_${termStr}`);
                const zone = document.getElementById(`zone_${termStr}`), container = document.getElementById(`cont_${termStr}`);
                if (!zone || !container || !crSpan || !ctSpan) return;
                
                container.classList.remove('term-grayed');
                let isBlockedByWT = Array.from(zone.children).some(el => el.classList.contains('wt') && el.style.display !== 'none');

                if (cellScore < startScore || isBlockedByWT) {
                    crSpan.innerText = "0"; ctSpan.innerText = "0"; container.classList.add('term-grayed');
                } else {
                    let defCr = t === 'SUM' ? 16 : defCrFW, defCt = t === 'SUM' ? 6 : defCtFW;
                    crSpan.innerText = crSpan.dataset.userVal !== undefined ? crSpan.dataset.userVal : defCr;
                    ctSpan.innerText = ctSpan.dataset.userVal !== undefined ? ctSpan.dataset.userVal : defCt;
                    if (crSpan.innerText === "0" || ctSpan.innerText === "0") container.classList.add('term-grayed');
                }
            });
        }
        updateCredits();
        injectCoopHeaders();
        highlightCurrentTerm(); 
        
        document.querySelectorAll('.cgpa-info-box').forEach(e => e.remove()); 
        document.querySelectorAll('.discipline-info-box').forEach(e => e.remove()); 
        
        let progName = document.getElementById('programSelect').value.toUpperCase().replace(/\s+/g, ' ').trim();
        let gpaThreshold = programGpaThresholds[progName];
        if (gpaThreshold === undefined) gpaThreshold = 2.0;

        for(let y=1; y<=7; y++) {
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let termYear = (t === 'WIN') ? (baseYear + y) : (baseYear + y - 1);
                
                let cgpaKey = `${termYear}_${t}`;
                let cgpaInfo = studentCGPAData[cgpaKey];
                if (cgpaInfo) {
                    let container = document.getElementById(`cont_Y${y}_${t}`);
                    if (container) {
                        let gpaDiv = document.createElement('div');
                        gpaDiv.className = 'cgpa-info-box';
                        gpaDiv.style.fontSize = '10px';
                        gpaDiv.style.padding = '4px 6px';
                        gpaDiv.style.fontWeight = 'bold';
                        gpaDiv.style.textAlign = 'center';
                        
                        let gpaVal = cgpaInfo.gpa_val;
                        let displayVal = gpaVal === -1 ? "N/A" : gpaVal;
                        
                        if (gpaVal === -1) {
                            gpaDiv.style.backgroundColor = 'transparent';
                            gpaDiv.style.color = 'inherit';
                            gpaDiv.style.borderTop = '1px solid rgba(0,0,0,0.06)';
                        } else if (gpaVal <= gpaThreshold) {
                            gpaDiv.style.backgroundColor = '#c0392b'; gpaDiv.style.color = '#ffffff';
                        } else if (gpaVal <= gpaThreshold + 0.2) {
                            gpaDiv.style.backgroundColor = '#e67e22'; gpaDiv.style.color = '#ffffff';
                        } else {
                            gpaDiv.style.backgroundColor = 'transparent';
                            gpaDiv.style.color = 'inherit';
                            gpaDiv.style.borderTop = '1px solid rgba(0,0,0,0.06)';
                        }
                        // NOU: Formatul complet cu CGPA
                        gpaDiv.innerText = `GPA past ${cgpaInfo.credits_val}CR : ${displayVal}  (CGPA ${cgpaInfo.cgpa} / ${cgpaInfo.tot_cr}CR total)`;
                        
                        let termHeader = container.querySelector('.term-header');
                        if (termHeader) {
                            termHeader.parentNode.insertBefore(gpaDiv, termHeader.nextSibling);
                        }
                    }
                }
                
                let discKey = `${termYear}_${t}`;
                let discText = studentTermDisciplines[discKey];
                if (discText) {
                    let container = document.getElementById(`cont_Y${y}_${t}`);
                    if (container) {
                        let dDiv = document.createElement('div');
                        dDiv.className = 'discipline-info-box';
                        dDiv.style.fontSize = '9px';
                        dDiv.style.padding = '3px 6px';
                        dDiv.style.backgroundColor = '#f1f5f8';
                        dDiv.style.color = '#34495e';
                        dDiv.style.borderBottom = '1px solid #e2e6ea';
                        dDiv.style.textAlign = 'center';
                        dDiv.style.fontWeight = 'bold';
                        
                        let acaYearStr = (t === 'WIN') ? `${termYear-1}-${termYear}` : `${termYear}-${termYear+1}`;
                        let displaySeason = t === 'SUM' ? 'Summer' : (t === 'WIN' ? 'Winter' : 'Fall');
                        
                        dDiv.innerText = `${acaYearStr} ${displaySeason}: ${discText}`;
                        
                        let termHeader = container.querySelector('.term-header');
                        if (termHeader) {
                            termHeader.parentNode.insertBefore(dDiv, termHeader.nextSibling);
                        }
                    }
                }
            });
        }
    }

    function highlightCurrentTerm() {
        const now = new Date();
        const currYear = now.getFullYear();
        const currMonth = now.getMonth(); 
        let currSeason = 'WIN';
        if (currMonth >= 4 && currMonth <= 7) currSeason = 'SUM';
        else if (currMonth >= 8 && currMonth <= 11) currSeason = 'FALL';
        
        const pTerm = document.getElementById('startTerm').value;
        const pYear = parseInt(document.getElementById('startYear').value);
        const baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;
        
        document.querySelectorAll('.current-term-highlight').forEach(el => el.classList.remove('current-term-highlight'));
        
        for(let y=1; y<=7; y++) {
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let termYear = (t === 'WIN') ? (baseYear + y) : (baseYear + y - 1);
                if (termYear === currYear && t === currSeason) {
                    let cont = document.getElementById(`cont_Y${y}_${t}`);
                    if (cont) cont.classList.add('current-term-highlight');
                }
            });
        }
    }
    const buildGrid = () => {
        const tbody = document.getElementById('tableBody');
        const y0 = tbody.rows[0]; tbody.innerHTML = ''; tbody.appendChild(y0);
        const pTerm = document.getElementById('startTerm').value, pYear = parseInt(document.getElementById('startYear').value), baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;

        for(let y=1; y<=7; y++){
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="year-label">Y ${y} <span class="year-subtext">${baseYear+y-1}-${baseYear+y}</span></td>
                <td class="col-summer-bg"><div class="term-container" id="cont_Y${y}_SUM" style="height:100%; min-height:120px;">
                    <div class="term-header"><span>Cr: <span class="calc-cr" id="cr_Y${y}_SUM">0</span></span><div class="limit-group">MaxCr:<span class="val-click cr-val" id="maxcr_Y${y}_SUM" onclick="showLimitPopup(this, 'cr', 'Y${y}_SUM')">16</span> Max # courses:<span class="val-click ct-val" id="maxct_Y${y}_SUM" onclick="showLimitPopup(this, 'ct', 'Y${y}_SUM')">6</span></div></div>
                    <div class="drop-zone" id="zone_Y${y}_SUM" data-term="Y${y}_SUM" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div></td>
                <td class="col-fall-bg"><div class="term-container" id="cont_Y${y}_FALL" style="height:100%; min-height:120px;">
                    <div class="term-header"><span>Cr: <span class="calc-cr" id="cr_Y${y}_FALL">0</span></span><div class="limit-group">MaxCr:<span class="val-click cr-val" id="maxcr_Y${y}_FALL" onclick="showLimitPopup(this,'cr','Y${y}_FALL')">18</span> Max # courses:<span class="val-click ct-val" id="maxct_Y${y}_FALL" onclick="showLimitPopup(this,'ct','Y${y}_FALL')">5</span></div></div>
                    <div class="drop-zone" id="zone_Y${y}_FALL" data-term="Y${y}_FALL" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div></td>
                <td class="col-winter-bg"><div class="term-container" id="cont_Y${y}_WIN" style="height:100%; min-height:120px;">
                    <div class="term-header"><span>Cr: <span class="calc-cr" id="cr_Y${y}_WIN">0</span></span><div class="limit-group">MaxCr:<span class="val-click cr-val" id="maxcr_Y${y}_WIN" onclick="showLimitPopup(this,'cr','Y${y}_WIN')">18</span> Max # courses:<span class="val-click ct-val" id="maxct_Y${y}_WIN" onclick="showLimitPopup(this,'ct','Y${y}_WIN')">5</span></div></div>
                    <div class="drop-zone" id="zone_Y${y}_WIN" data-term="Y${y}_WIN" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div></td>`;
            tbody.appendChild(tr);
        }
    };

    async function triggerGridRebuild() { 
        if(document.getElementById('workspace').style.visibility === 'visible') { 
            document.getElementById('loadingOverlay').style.display = 'flex'; 
            
            try {
                const unalloc = document.getElementById('unallocatedZone');
                document.querySelectorAll('td .drop-zone').forEach(z => {
                    if (z.id !== 'zone_Y0_ANY') {
                        Array.from(z.children).forEach(c => unalloc.appendChild(c));
                    }
                });
                
                buildGrid(); 
                
                await loadTranscriptAndMapInstitute();

                const isChecked = document.getElementById('coopRegistered').checked;
                document.querySelectorAll('.course-box.wt').forEach(box => {
                    box.style.display = isChecked ? 'block' : 'none';
                });

                enforceAndHighlightTerms(); 
                sortUnallocatedDOM();
                updateCredits();
                checkWT();
                runLiveCheck();
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        } 
    }

    function toggleTools() { document.getElementById('toolsMenu').classList.toggle('collapsed'); }
    
    function lockAllPlacedCourses() {
        document.querySelectorAll('td .drop-zone').forEach(z => { 
            Array.from(z.children).forEach(c => {
                if (coursesData[c.id] && !coursesData[c.id].locked) {
                    coursesData[c.id].locked = true;
                    let newEl = createCourseElement(c.id);
                    z.replaceChild(newEl, c);
                }
            }); 
        });
    }

    function resetAllCourses() {
        const unalloc = document.getElementById('unallocatedZone');
        document.querySelectorAll('td .drop-zone').forEach(z => { 
            Array.from(z.children).forEach(c => {
                if(!coursesData[c.id].locked) unalloc.appendChild(c);
            }); 
        });
        sortUnallocatedDOM(); updateCredits(); checkWT(); clearAllHighlights(); enforceAndHighlightTerms(); runLiveCheck();
    }

    function addRepeatCourse() {
        const sel = document.getElementById('repeatCourseSelect'); 
        const cid = sel.value; 
        if(!cid) return;
        
        const orig = coursesData[cid];
        
        let i = 1; 
        while(coursesData[`REP${i}_${cid}`]) i++;
        const fakeId = `REP${i}_${cid}`;
        
        const suffixStr = i > 1 ? ` ${i}` : "";
        const newName = `${orig.full_name} REPEATED${suffixStr}`;
        
        repeatedCoursesList.push(cid);
        
        let localPrereq = "None";
        if (i > 1) localPrereq = `REP${i-1}_${cid}`;
        
        if (orig.prereqs && orig.prereqs !== 'None' && orig.prereqs !== 'N/A') {
            if (!orig.prereqs.includes(fakeId)) orig.prereqs += ", " + fakeId;
        } else {
            orig.prereqs = fakeId;
        }

        Object.values(coursesData).forEach(c => {
            if (c.id !== cid && c.id !== fakeId) {
                if (c.prereqs && c.prereqs !== 'None' && c.prereqs !== 'N/A') {
                    let reqList = parseCourseIDs(c.prereqs);
                    if (reqList.includes(cid)) {
                        if (!c.prereqs.includes(fakeId)) {
                            c.prereqs += `, ${fakeId}`;
                        }
                    }
                }
            }
        });

        coursesData[fakeId] = { 
            id: fakeId, 
            display: newName, 
            full_name: newName, 
            title: "Previous attempt (Failed)", 
            credit: 0, 
            type: orig.type, 
            is_wt: false, 
            is_ecp: false, 
            prereqs: localPrereq, 
            coreqs: "None", 
            is_prereq_for: orig.is_prereq_for, 
            is_coreq_for: "None", 
            terms: orig.terms, 
            locked: false 
        };
        
        document.getElementById('unallocatedZone').appendChild(createCourseElement(fakeId)); 
        sortUnallocatedDOM();
        alert(`Added ${newName}. It is now a pre-req for the original course and its dependents.`); 
        runLiveCheck();
    }

    function lockPastTerms() {
        const pTerm = document.getElementById('startTerm').value;
        const pYear = parseInt(document.getElementById('startYear').value);
        const baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;
        
        const now = new Date();
        const currYear = now.getFullYear();
        const currMonth = now.getMonth(); 
        const currDay = now.getDate();

        for(let y=1; y<=7; y++) {
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let termYear = (t === 'WIN') ? (baseYear + y) : (baseYear + y - 1);
                
                let isPast = false;
                if (termYear < currYear) {
                    isPast = true;
                } else if (termYear === currYear) {
                    if (t === 'WIN' && (currMonth > 1 || (currMonth === 1 && currDay > 1))) isPast = true;
                    if (t === 'SUM' && (currMonth > 4 || (currMonth === 4 && currDay > 25))) isPast = true;
                    if (t === 'FALL' && (currMonth > 8 || (currMonth === 8 && currDay > 20))) isPast = true;
                }

                if (isPast) {
                    let zone = document.getElementById(`zone_Y${y}_${t}`);
                    let ctSpan = document.getElementById(`maxct_Y${y}_${t}`);
                    let container = document.getElementById(`cont_Y${y}_${t}`);
                    
                    if (zone && ctSpan) {
                        let courseCount = Array.from(zone.children).filter(el => {
                            let c = coursesData[el.id];
                            return c && !c.is_wt && c.type !== 'REPEAT';
                        }).length;
                        
                        ctSpan.innerText = courseCount;
                        ctSpan.dataset.userVal = courseCount; 
                        
                        if (courseCount === 0 && container) {
                            container.classList.add('term-grayed');
                        }
                    }
                }
            });
        }
    }

    function parseConcordiaTerm(termStr) {
        let s = termStr.toString().trim().toUpperCase();
        let year = new Date().getFullYear();
        let season = 'FALL';
        
        let psMatch = s.match(/^(2\d{3})$/);
        if (psMatch) {
            let yy = parseInt(psMatch[1].substring(1, 3)); 
            let termDigit = psMatch[1].charAt(3);          
            let acaYear = 2000 + yy;
            
            if (termDigit === '1') { season = 'SUM'; year = acaYear; }
            else if (termDigit === '2') { season = 'FALL'; year = acaYear; }
            else if (termDigit === '3' || termDigit === '4') { season = 'WIN'; year = acaYear + 1; }
            return { year, season };
        }
        
        if (s.includes('WIN')) season = 'WIN';
        else if (s.includes('SUM') || s.includes('SU ')) season = 'SUM';
        else if (s.includes('FALL') || s.includes('FA ')) season = 'FALL';
        
        let yearMatch = s.match(/\d{4}/g);
        if (yearMatch) {
            if (yearMatch.length > 1) {
                let baseAcaYear = parseInt(yearMatch[0]); 
                if (season === 'WIN') {
                    year = baseAcaYear + 1; 
                } else {
                    year = baseAcaYear;     
                }
            } else {
                year = parseInt(yearMatch[0]);
            }
        } else {
            let shortYearMatch = s.match(/\d{2}/);
            if (shortYearMatch) year = 2000 + parseInt(shortYearMatch[0]);
        }
        
        return { year, season };
    }

    async function loadTranscriptAndMapInstitute() {
        const prog = document.getElementById('programSelect').value;
        const sYear = parseInt(document.getElementById('startYear').value);
        
        let currentSid = "";
        let adminInput = document.getElementById('adminSidInput');
        
        if (adminInput && adminInput.value.trim() !== "") {
            currentSid = adminInput.value.trim();
        } else {
            let displaySid = document.getElementById('displayViewingSid');
            if (displaySid) {
                currentSid = displaySid.innerText.split('-')[0].trim();
            }
        }
        
        if (!currentSid || currentSid === "ADMIN") return;

        try {
            const res = await fetch('/get_transcript', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({student_id: currentSid})
            });
            const data = await res.json();
            
            studentTermDisciplines = {};
            if (data.term_disciplines) {
                Object.keys(data.term_disciplines).forEach(rawTerm => {
                    let parsed = parseConcordiaTerm(rawTerm);
                    let key = `${parsed.year}_${parsed.season}`;
                    studentTermDisciplines[key] = data.term_disciplines[rawTerm];
                });
            }

            if (data.student_name) {
                let displaySid = document.getElementById('displayViewingSid');
                if (displaySid) {
                    displaySid.innerText = currentSid + " - " + data.student_name;
                }
            }

            if (!data.transcript) return;
            
            const currentYr = new Date().getFullYear();
            let transcriptIds = new Set();

            let firstCoreYear = 9999;
            let firstCoreTerm = "Fall";
            let minScore = 99999;
            
            data.transcript.forEach(t => {
                let rawCid = t.course.toUpperCase();
                if (rawCid.includes('WT')) return; 
                
                let cleanId = rawCid.replace(/\s+/g, '');
                let matchedKey = Object.keys(coursesData).find(k => k.replace(/\s+/g, '').toUpperCase() === cleanId);
                
                if (matchedKey && !coursesData[matchedKey].is_ecp) {
                    let parsed = parseConcordiaTerm(t.term);
                    let y = parsed.year;
                    let s = parsed.season;
                    
                    let score = y * 10 + (s === 'WIN' ? 1 : (s === 'SUM' ? 2 : 3));
                    if (score < minScore) {
                        minScore = score;
                        firstCoreYear = y;
                        firstCoreTerm = s === 'WIN' ? 'Winter' : 'Fall'; 
                    }
                }
            });
            
            if (firstCoreYear !== 9999) {
                let startYearEl = document.getElementById('startYear');
                let startTermEl = document.getElementById('startTerm');
                
                let options = Array.from(startYearEl.options).map(o => parseInt(o.value));
                if (!options.includes(firstCoreYear)) {
                    startYearEl.add(new Option(firstCoreYear, firstCoreYear));
                    let opts = Array.from(startYearEl.options);
                    opts.sort((a,b) => parseInt(b.value) - parseInt(a.value));
                    startYearEl.innerHTML = '';
                    opts.forEach(o => startYearEl.add(o));
                }
                
                if (startYearEl.value != firstCoreYear || startTermEl.value != firstCoreTerm) {
                    startYearEl.value = firstCoreYear;
                    startTermEl.value = firstCoreTerm;
                    
                    if (document.getElementById('coopRegistered').checked) {
                        updateCoopYears();
                        document.getElementById('coopStartYear').value = firstCoreYear;
                        document.getElementById('coopStartTerm').value = "FALL";
                    }
                    updateAllSelectColors();
                    
                    buildGrid(); 
                }
            }


            data.transcript.forEach(t => {
                let coursesToProcess = [t];

                let matchSplit = t.course.match(/^([A-Z]{3,4})(490|6990)$/);
                if (matchSplit) {
                    let base = matchSplit[1]; 
                    let num = matchSplit[2];  
                    let halfCredit = (parseFloat(t.credit) || 6.0) / 2;

                    coursesToProcess = [
                        { ...t, course: `${base}${num}A`, credit: halfCredit, forceSeason: 'FALL' },
                        { ...t, course: `${base}${num}B`, credit: halfCredit, forceSeason: 'WIN' }
                    ];
                }

                coursesToProcess.forEach(item => {
                    let rawCid = item.course.toUpperCase();
                    
                    if (rawCid.startsWith('CWTE10') || rawCid.startsWith('CWT10') || rawCid === 'WT1') rawCid = 'WT1';
                    if (rawCid.startsWith('CWTE20') || rawCid.startsWith('CWT20') || rawCid.startsWith('ACCE10') || rawCid === 'WT2') rawCid = 'WT2';
                    if (rawCid.startsWith('CWTE30') || rawCid.startsWith('CWT30') || rawCid === 'WT3') rawCid = 'WT3';
                    
                    let cleanId = rawCid.replace(/\s+/g, '');
                    let matchedKey = Object.keys(coursesData).find(k => k.replace(/\s+/g, '').toUpperCase() === cleanId);
                    
                    let finalCid = matchedKey ? matchedKey : cleanId;
                    transcriptIds.add(finalCid);

                    let tCredit = parseFloat(item.credit) || 0;

                    if (!matchedKey) {
                        let formattedName = finalCid.replace(/^([A-Z]+)(\d+.*)$/, '$1 $2');
                        let isWt = finalCid.includes('WT');

                        let inferredType = "EXTRA";
                        if (cleanId.match(/^(ECON|PHIL|ENGL|HIST|POLI|RELI|SOCI|THEO|ANTH|PSYC|SPAN|FREN|MANA)/)) inferredType = "ECP";
                        else if (cleanId.match(/^(MATH|PHYS|CHEM|BIOL)/)) inferredType = "BASIC SCIENCE";

                        coursesData[finalCid] = {
                            id: finalCid, 
                            display: `${formattedName} (${isWt ? 0 : tCredit} cr)`, 
                            full_name: formattedName, 
                            title: "From Transcript",
                            credit: isWt ? 0 : tCredit, 
                            type: inferredType, 
                            is_wt: isWt, 
                            is_ecp: inferredType === "ECP",
                            prereqs: "None", coreqs: "None", is_prereq_for: "None", is_coreq_for: "None",
                            terms: "ANY", locked: true,
                            from_transcript: true
                        };

                        let div = createCourseElement(finalCid);
                        document.getElementById('zone_Y0_ANY').appendChild(div);
                    } else {
                        if (!finalCid.includes('WT')) {
                            coursesData[finalCid].credit = tCredit;
                        }
                        coursesData[finalCid].from_transcript = true; 
                    }

                    let el = document.getElementById(finalCid);
                    if(el) {
                        let currentYr = new Date().getFullYear();
                        
                        let sYearInput = document.getElementById('startYear').value;
                        let sYear = parseInt(sYearInput) || currentYr;
                        let sTerm = document.getElementById('startTerm').value; 
                        let baseYear = sTerm === 'Winter' ? sYear - 1 : sYear;
                        
                        let parsed = parseConcordiaTerm(item.term);
                        let tYear = parsed.year;
                        let tSeason = parsed.season;
                        if (item.forceSeason) tSeason = item.forceSeason;
                        
                        let targetZoneId = 'zone_Y0_ANY';
                        
                        let getAbsIdx = (y, s) => y * 3 + (s === 'WIN' ? 0 : (s === 'SUM' ? 1 : 2));
                        
                        let courseIdx = getAbsIdx(tYear, tSeason);
                        let programIdx = getAbsIdx(sYear, sTerm === 'Fall' ? 'FALL' : 'WIN');
                        let gridStartIdx = getAbsIdx(baseYear, 'SUM'); 
                        
                        if (courseIdx < programIdx) {
                            targetZoneId = 'zone_Y0_ANY'; 
                        } else {
                            let offset = courseIdx - gridStartIdx;
                            if (offset >= 0) {
                                let relY = Math.floor(offset / 3) + 1;
                                let relS = offset % 3;
                                let termName = relS === 0 ? 'SUM' : (relS === 1 ? 'FALL' : 'WIN');
                                
                                if (relY >= 1 && relY <= 7) {
                                    targetZoneId = `zone_Y${relY}_${termName}`;
                                }
                            }
                        }

                        let tz = document.getElementById(targetZoneId);
                        if(!tz) tz = document.getElementById('zone_Y0_ANY');
                        
                        coursesData[finalCid].locked = true; 
                        coursesData[finalCid].from_transcript = true;
                        coursesData[finalCid].original_zone = tz.id;  
                        
                        if (finalCid.includes('WT')) coursesData[finalCid].credit = 0; 
                        
                        tz.appendChild(el);
                        let newEl = createCourseElement(finalCid);
                        tz.replaceChild(newEl, el);
                    }
                });
            });

            Object.keys(coursesData).forEach(id => {
                let c = coursesData[id];
                if (c.is_ecp && !transcriptIds.has(id)) {
                    let postReqs = parseCourseIDs(c.is_prereq_for);
                    let eNevoieDeEl = postReqs.some(req => transcriptIds.has(req));
                    if (eNevoieDeEl) {
                        coursesData[id].locked = true;
                        let el = document.getElementById(id);
                        if(el) {
                            document.getElementById('zone_Y0_ANY').appendChild(el);
                            let newEl = createCourseElement(id);
                            document.getElementById('zone_Y0_ANY').replaceChild(newEl, el);
                        }
                    }
                }
            });

            lockPastTerms();
            
            updateCredits();
            
        } catch(e) {
            console.error("Eroare la citirea transcript-ului:", e);
        }
    }


    function getCourseHTML(c) {
        let typeStr = (c.type || "").toUpperCase();
        
        if(c.is_wt) typeStr = "<b>WT</b>"; 
        else if(typeStr.includes("ENG") && typeStr.includes("CORE")) typeStr = "<b>engCORE</b>"; 
        else if(typeStr.includes("PRG") && typeStr.includes("CORE")) typeStr = "<b>prgCORE</b>"; 
        else if(typeStr === "REPEAT") typeStr = "<b>REPEAT</b>"; 
        else if(typeStr.includes("TE")) typeStr = "TE"; 
        else if(typeStr.includes("GEN") || typeStr.includes("ELECTIVE") || typeStr === "ECP") typeStr = "ECP"; 
        else if(typeStr === "EXTRA") typeStr = "EXTRA"; 
        else typeStr = typeStr ? typeStr : "EXTRA"; 

        const orderMap = { 'SUM': 1, 'FALL': 2, 'WIN': 3 }; 
        const colorMap = { 'SUM': 'tag-sum', 'FALL': 'tag-fall', 'WIN': 'tag-win' };
        
        let termsArr = (c.terms || "").split(',').map(t => t.trim().toUpperCase()
            .replace("WINTER","WIN")
            .replace(/SUM\s*1/g, "SUM")
            .replace(/SUM\s*2/g, "SUM")
            .replace("SUMMER", "SUM")
        ).filter(t => t && t !== "N/A");
        
        termsArr = [...new Set(termsArr)]; 
        termsArr.sort((a, b) => (orderMap[a] || 99) - (orderMap[b] || 99));
        
        let termHTML = (c.is_wt || c.is_ecp || typeStr === "EXTRA") ? '<span class="term-tag tag-any">ANY</span>' : termsArr.map(t => `<span class="term-tag ${colorMap[t] || 'tag-any'}">${t}</span>`).join('');
        let dispCr = (c.is_wt || typeStr === "<b>REPEAT</b>") ? 0 : c.credit;
        
        let checkbox = `<input type="checkbox" class="lock-checkbox" ${c.locked ? 'checked' : ''} onclick="toggleLock('${c.id}'); event.stopPropagation();">`;

        let titleClass = c.locked ? "locked-text" : "";

        return `${checkbox}<div class="${titleClass}" style="font-weight: bold;">${c.full_name} (${dispCr} cr)</div><div style="font-style: italic; font-size: 10px; color: #555; margin: 2px 0; line-height: 1.1;">${c.title || ''}</div><span class="course-meta">[${typeStr}] ${termHTML}</span>`;
    }

    function createCourseElement(cid) {
        const c = coursesData[cid], div = document.createElement('div'); div.id = cid; div.className = `course-box ${c.is_wt ? 'wt' : ''} ${c.is_ecp ? 'ecp' : ''}`; div.draggable = true; div.innerHTML = getCourseHTML(c); 
        div.ondragstart = e => { e.dataTransfer.setData("text", e.target.id); showCourseInfo(e.target.id); }; div.onclick = (e) => { e.stopPropagation(); showCourseInfo(cid); }; return div;
    }

    function parseCourseIDs(str) { if (!str || str === 'None' || str === 'N/A') return []; return str.match(/(?:REP_)?[A-Z]{3,4}\s?\d{3}[A-Z]?|WT\d/gi)?.map(m => m.replace(/\s+(?!\()/, '').toUpperCase()) || []; }

    function clearAllHighlights() { document.querySelectorAll('.course-box').forEach(b => b.classList.remove('selected', 'highlight-prereq', 'highlight-coreq', 'highlight-postreq', 'highlight-postcoreq')); document.getElementById('courseInfoPanel').style.display = 'none'; }
    document.addEventListener('click', function(e) { if (!e.target.closest('.course-box') && !e.target.closest('#courseInfoPanel') && !e.target.closest('.tools-container')) clearAllHighlights(); });

    function highlightPreReqs(cid) {
        if(!coursesData[cid]) return;
        parseCourseIDs(coursesData[cid].prereqs).forEach(reqId => { const el = document.getElementById(reqId); if (el && !el.classList.contains('highlight-prereq')) { el.classList.add('highlight-prereq'); highlightPreReqs(reqId); } });
        parseCourseIDs(coursesData[cid].coreqs).forEach(reqId => { const el = document.getElementById(reqId); if (el && !el.classList.contains('highlight-coreq') && !el.classList.contains('highlight-prereq')) el.classList.add('highlight-coreq'); });
    }

    function highlightPostReqs(cid) {
        if(!coursesData[cid]) return;
        parseCourseIDs(coursesData[cid].is_prereq_for).forEach(postId => { const el = document.getElementById(postId); if (el && !el.classList.contains('highlight-postreq')) { el.classList.add('highlight-postreq'); highlightPostReqs(postId); } });
        parseCourseIDs(coursesData[cid].is_coreq_for).forEach(postId => { const el = document.getElementById(postId); if (el && !el.classList.contains('highlight-postcoreq') && !el.classList.contains('highlight-postreq')) el.classList.add('highlight-postcoreq'); });
    }

    function showCourseInfo(cid) {
        const c = coursesData[cid]; if (!c) return; clearAllHighlights(); document.getElementById(cid)?.classList.add('selected');
        highlightPreReqs(cid); highlightPostReqs(cid); document.getElementById('courseInfoPanel').style.display = 'block';
        document.getElementById('info_title').innerText = c.title ? `${c.full_name} - ${c.title}` : (c.full_name || c.display);
        document.getElementById('info_type').innerText = c.type || '-'; document.getElementById('info_cr').innerText = c.credit || '0'; document.getElementById('info_terms').innerText = c.terms || '-';
        document.getElementById('info_prereq').innerText = (c.prereqs && c.prereqs !== 'None' && c.prereqs !== 'N/A') ? c.prereqs : 'None';
        document.getElementById('info_coreq').innerText = (c.coreqs && c.coreqs !== 'None' && c.coreqs !== 'N/A') ? c.coreqs : 'None';
        document.getElementById('info_post_prereq').innerText = (c.is_prereq_for && c.is_prereq_for !== 'None') ? c.is_prereq_for : 'None';
        document.getElementById('info_post_coreq').innerText = (c.is_coreq_for && c.is_coreq_for !== 'None') ? c.is_coreq_for : 'None';
    }

    async function fetchCoursesForProgram(progName) {
        if(!progName) return;
        const res = await fetch('/get_courses', { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({program: progName}) 
        });
        const data = await res.json();
        
        coursesData = {};
        if (data.courses) {
            data.courses.forEach(c => { coursesData[c.id] = c; });
        }
    }

    document.getElementById('programSelect').onchange = async function() {
        document.getElementById('loadingOverlay').style.display = 'flex'; 
        
        try {
            updateRoutingInfo(); 
            document.getElementById('workspace').style.visibility = 'visible'; 
            document.getElementById('toolsMenu').classList.remove('collapsed');
            
            const isChecked = document.getElementById('coopRegistered').checked;
            document.getElementById('coopDetailsGroup').style.opacity = isChecked ? '1' : '0.4';
            document.getElementById('coopStartTerm').disabled = !isChecked; document.getElementById('coopStartYear').disabled = !isChecked;
            
            if (isChecked) {
                updateCoopYears();
                document.getElementById('coopStartYear').value = document.getElementById('startYear').value;
                document.getElementById('coopStartTerm').value = "FALL";
            }
            updateAllSelectColors();
            
            buildGrid(); 
            
            const unalloc = document.getElementById('unallocatedZone');
            unalloc.innerHTML = '';
            
            await fetchCoursesForProgram(this.value);
            Object.values(coursesData).forEach(c => { unalloc.appendChild(createCourseElement(c.id)); });

            await loadTranscriptAndMapInstitute();

            document.querySelectorAll('.course-box.wt').forEach(box => {
                box.style.display = isChecked ? 'block' : 'none';
            });

            sortUnallocatedDOM(); 
            populateRepeatSelect(); 
            updateCredits(); 
            checkWT(); 
            enforceAndHighlightTerms(); 
            runLiveCheck();
        } catch (error) {
            console.error("Eroare la incarcare:", error);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    };

    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
    function dragLeave(e) { e.currentTarget.classList.remove('dragover'); }
    
    function drop(e) {
        e.preventDefault(); 
        const targetZone = e.target.closest('.drop-zone'); 
        if(targetZone) targetZone.classList.remove('dragover');
        
        const id = e.dataTransfer.getData("text");
        let el = document.getElementById(id);
        
        if(el && targetZone) { 
            targetZone.appendChild(el); 
            
            if (coursesData[id] && coursesData[id].is_wt) {
                if (targetZone.id === 'unallocatedZone') {
                    coursesData[id].locked = false; 
                } else {
                    coursesData[id].locked = true;  
                }
                let newEl = createCourseElement(id);
                targetZone.replaceChild(newEl, el);
                el = newEl; 
            }
            
            if(targetZone.id === 'unallocatedZone') sortUnallocatedDOM(); 
            enforceAndHighlightTerms(); 
            updateCredits(); 
            checkWT(); 
            runLiveCheck(); 
        }
    }

    function updateCredits() {
        for(let y=1; y<=7; y++) {
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let total = 0, zone = document.getElementById(`zone_Y${y}_${t}`); if(!zone) return;
                Array.from(zone.children).forEach(b => {
                    const isSpc = b.classList.contains('wt') || (coursesData[b.id] && coursesData[b.id].type === "REPEAT");
                    total += isSpc ? 0 : (coursesData[b.id] ? coursesData[b.id].credit : 0);
                });
                const crSpan = document.getElementById(`cr_Y${y}_${t}`);
                if(crSpan) { crSpan.innerText = total.toFixed(1); const limitVal = parseFloat(document.getElementById(`maxcr_Y${y}_${t}`).innerText); if (limitVal > 0 && total > limitVal) crSpan.style.color = '#c0392b'; else crSpan.style.color = '#912338'; }
            });
        }
    }

    function checkWT() {
        const isCoop = document.getElementById('coopRegistered').checked;
        if (!isCoop) { document.getElementById('generateBtn').disabled = false; return; }
        const hasUnplacedWT = Array.from(document.getElementById('unallocatedZone').children).some(el => coursesData[el.id]?.is_wt && el.style.display !== 'none');
        document.getElementById('generateBtn').disabled = false; 
    }

    

    document.getElementById('moveEcpBtn').onclick = () => {
        const z0 = document.getElementById('zone_Y0_ANY'); Object.keys(coursesData).forEach(id => { if(coursesData[id].is_ecp) z0.appendChild(document.getElementById(id)); });
        updateCredits(); checkWT(); runLiveCheck();
    };

    document.getElementById('generateBtn').onclick = async function() {
        this.innerText = "Processing sequence..."; 
        this.disabled = true;
        const limits = {}, counts = {}, isCoop = document.getElementById('coopRegistered').checked, placed = {}; 
        
        document.querySelectorAll('.cr-val').forEach(i => limits[i.id.replace('maxcr_','')] = i.innerText); 
        document.querySelectorAll('.ct-val').forEach(i => counts[i.id.replace('maxct_','')] = i.innerText);
        
        document.querySelectorAll('td .drop-zone').forEach(z => { 
            if(z.children.length > 0) {
                placed[z.dataset.term] = Array.from(z.children)
                    .filter(c => isCoop || !coursesData[c.id]?.is_wt)
                    .map(c => c.id);
            }
        });
        
        const unallocZone = document.getElementById('unallocatedZone'); 
        const unalloc = Array.from(unallocZone.children).filter(c => isCoop || !coursesData[c.id]?.is_wt).map(c => c.id);
        
        try {
            const res = await fetch('/generate', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({ 
                    program: document.getElementById('programSelect').value, 
                    term_limits: limits, 
                    count_limits: counts, 
                    placed: placed, 
                    unallocated: unalloc, 
                    repeated: repeatedCoursesList 
                }) 
            });
            
            if (!res.ok) throw new Error('Generation failed on server.');
            const result = await res.json();
            
            if (result.error) {
                alert("‚ùå Generation Error:\n" + result.error);
                return; 
            }

            document.querySelectorAll('td .drop-zone:not(#zone_Y0_ANY)').forEach(z => z.innerHTML = '');
            
            Object.keys(result.sequence).forEach(year => {
                const yNum = year.split(' ')[1]; 
                ['SUM','FALL','WIN'].forEach(t => {
                    const z = document.getElementById(`zone_Y${yNum}_${t}`); 
                    if(z && result.sequence[year][t].cursuri) { 
                        result.sequence[year][t].cursuri.forEach(c => { 
                            if(coursesData[c.id]) z.appendChild(createCourseElement(c.id)); 
                        }); 
                    }
                });
            });
            
            unallocZone.innerHTML = '';
            if(result.unallocated) {
                result.unallocated.forEach(c => { 
                    if(coursesData[c.id]) unallocZone.appendChild(createCourseElement(c.id)); 
                });
            }
            
            sortUnallocatedDOM(); 
            enforceAndHighlightTerms(); 
            updateCredits(); 
            checkWT(); 
            runLiveCheck();
            
        } catch (error) { 
            console.error(error); 
            alert("An error occurred while generating."); 
        } finally { 
            this.innerText = "Generate Sequence"; 
            this.disabled = false; 
            checkWT(); 
        }
    };

    function runLiveCheck() {
        let errors = [];
        let errorCids = new Set();
        let isCoop = document.getElementById('coopRegistered').checked;
        let takenSet = new Set();
        let currentSequence = [];

        Array.from(document.getElementById('unallocatedZone').children).forEach(el => {
            if (el.style.display !== 'none') {
                let c = coursesData[el.id];
                if (c) {
                    if (c.from_transcript && c.original_zone) {
                        let readableZone = c.original_zone.replace('zone_', '').replace('_', ' ');
                        errors.push(`<b>${c.id}</b> is on your transcript (taken in ${readableZone}) and cannot be unallocated.`);
                    } 
                    else if (isCoop || !c.is_wt) {
                        let t = (c.type || "").toUpperCase();
                        if (t.includes('CORE') || t === 'GEN' || t === 'ECP') {
                            errors.push(`Course <b>${c.id}</b> (${t}) must be placed.`);
                        }
                    }
                }
            }
        });

        let tNames = ['SUM', 'FALL', 'WIN'];
        currentSequence.push({ id: 'Y0_ANY', courses: Array.from(document.getElementById('zone_Y0_ANY').children).map(c=>c.id) });
        for(let y=1; y<=7; y++) {
            tNames.forEach(t => {
                let z = document.getElementById(`zone_Y${y}_${t}`);
                if (z) currentSequence.push({ id: `Y${y}_${t}`, courses: Array.from(z.children).map(c=>c.id), type: t, year: y });
            });
        }

        let wtIndices = [];
        let summerWTs = 0;
        let wt3Index = -1;

        currentSequence.forEach((term, index) => {
            term.courses.forEach(cid => takenSet.add(cid));
            if (term.id === 'Y0_ANY') return;

            let realCoursesCount = 0;
            let totalCr = 0;
            let hasWT = false;
            let isSummer = term.type.includes('SUM');

            term.courses.forEach(cid => {
                let c = coursesData[cid];
                if (!c) return;

                if (c.from_transcript && c.original_zone) {
                    let currentZoneId = term.id === 'Y0_ANY' ? 'zone_Y0_ANY' : `zone_${term.id}`;
                    if (currentZoneId !== c.original_zone) {
                        let readableOrig = c.original_zone.replace('zone_', '').replace('_', ' ');
                        let readableCurr = term.id.replace('_', ' ');
                        errors.push(`Transcript mismatch: <b>${c.id}</b> was taken in <b>${readableOrig}</b> but moved to <b>${readableCurr}</b>.`);
                    }
                }

                if (c.is_wt) {
                    hasWT = true;
                    if (isSummer) summerWTs++;
                    if (cid.includes('WT3')) wt3Index = index;
                } else if (c.type !== 'REPEAT') {
                    realCoursesCount++;
                    totalCr += c.credit;
                    
                    let map = {'FALL':'FALL', 'WIN':'WIN', 'SUM':'SUM'};
                    
                    if (!c.from_transcript) {
                        let termsUp = (c.terms || "ANY").toUpperCase();
                        let targetUp = map[term.type];
                        
                        if (termsUp !== 'ANY' && !termsUp.includes(targetUp)) {
                            errors.push(`<b>${cid}</b> is not offered in <b>${targetUp}</b>.`);
                        }

                        if (c.prereqs && c.prereqs !== 'None' && c.prereqs !== 'N/A') {
                            c.prereqs.split(/[;,]/).forEach(grp => {
                                let opts = parseCourseIDs(grp).filter(o => coursesData[o]);
                                if (opts.length > 0) {
                                    let satisfied = opts.some(opt => { return takenSet.has(opt) && !term.courses.includes(opt); });
                                    if (!satisfied) errors.push(`<b>${cid}</b> in ${term.id} missing pre-req group: [${opts.join(' or ')}].`);
                                }
                            });
                        }

                        if (c.coreqs && c.coreqs !== 'None' && c.coreqs !== 'N/A') {
                            c.coreqs.split(/[;,]/).forEach(grp => {
                                let opts = parseCourseIDs(grp).filter(o => coursesData[o]);
                                if (opts.length > 0 && !opts.some(opt => takenSet.has(opt))) {
                                    errors.push(`<b>${cid}</b> in ${term.id} missing co-req group: [${opts.join(' or ')}].`);
                                }
                            });
                        }
                    } 
                }
            });

            if (isCoop) {
                if (hasWT) {
                    wtIndices.push(index);
                    if (isSummer) {
                        if (realCoursesCount > 1) errors.push(`Year ${term.year} Summer: Max 1 course allowed alongside WT.`);
                    } else {
                        if (realCoursesCount > 1)  errors.push(`Term ${term.id}: Max 1 course allowed alongside WT.`);
                    }
                    if (term.courses.some(id => id.includes('490A') || id.includes('490B'))) {
                        errors.push(`Term ${term.id}: Capstone and WT in same term is not allowed.`);
                    }
                } 
            }
        });

        if (isCoop) {
            let summerSeasonsWithWT = new Set();
            wtIndices.forEach(idx => {
                let term = currentSequence[idx];
                if (term.type.includes('SUM')) summerSeasonsWithWT.add(term.year);
            });
            if (summerSeasonsWithWT.size > 2) errors.push(`Limit exceeded: WT placed in ${summerSeasonsWithWT.size} summers (Max: 2 allowed).`);
                
            if (wtIndices.length >= 3) {
                for (let i = 0; i < wtIndices.length - 2; i++) {
                    if (wtIndices[i+1] === wtIndices[i] + 1 && wtIndices[i+2] === wtIndices[i] + 2) {
                        errors.push("Invalid Sequence: You cannot have 3 consecutive Work Terms.");
                        break;
                    }
                }
            }

            if (wtIndices.length > 0) {
                let firstWtIdx = wtIndices[0];
                let studyTermsBefore = 0;
                
                for (let i = 1; i < firstWtIdx; i++) { 
                    let hasCredits = currentSequence[i].courses.some(cid => coursesData[cid] && !coursesData[cid].is_wt && coursesData[cid].credit > 0);
                    if (hasCredits) studyTermsBefore++;
                }

                if (studyTermsBefore < 2) {
                    errors.push("Invalid Sequence: There must be at least 2 study terms before your first Work Term.");
                }

                if (wtIndices.length > 1) {
                    let coreCrBefore = 0;
                    for (let i = 1; i < firstWtIdx; i++) {
                        currentSequence[i].courses.forEach(cid => {
                            let c = coursesData[cid];
                            if (c && !c.is_wt) {
                                let t = (c.type || "").toUpperCase();
                                if (t.includes('CORE') || t.includes('TE') || t.includes('PROG')) {
                                    coreCrBefore += c.credit;
                                }
                            }
                        });
                    }
                    if (coreCrBefore < 30) {
                        let firstWtName = currentSequence[firstWtIdx].courses.find(id => id.includes('WT')) || "WT";
                        errors.push(`Requirement not met: Only ${coreCrBefore} credits of CORE/TE before ${firstWtName}. Programs with multiple Work Terms require at least 30 CR before the first WT.`);
                    }
                }

                let lastWtIdx = wtIndices[wtIndices.length - 1]; 
                
                let pYear = parseInt(document.getElementById('startYear').value);
                let pTerm = document.getElementById('startTerm').value;
                let baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;

                let progName = document.getElementById('programSelect').value.toUpperCase().replace(/\s+/g, ' ').trim();
                let credits_Ft = programFtCredits[progName] || 99;
                if (credits_Ft === 0) credits_Ft = 99;

                for (let i = 1; i < lastWtIdx; i++) { 
                    let term = currentSequence[i];
                    let isSummer = term.type.includes('SUM');
                    
                    if (!isSummer) {
                        let termRealYear = term.type === 'WIN' ? baseYear + term.year : baseYear + term.year - 1;
                        let coopKey = `${termRealYear}_${term.type}`;
                        
                        let isCoopRegistered = studentCoopData && studentCoopData[coopKey] !== undefined;
                        
                        let termHasWt = term.courses.some(cid => coursesData[cid] && coursesData[cid].is_wt);

                        if (isCoopRegistered && !termHasWt) {
                            let prevCr = 0;
                            term.courses.forEach(cid => {
                                let c = coursesData[cid];
                                if (c && !c.is_wt && c.type !== 'REPEAT') prevCr += c.credit;
                            });
                            
                            if (prevCr < credits_Ft && credits_Ft !== 99) {
                                let lastWtName = currentSequence[lastWtIdx].courses.find(id => id.includes('WT')) || "last WT";
                                errors.push(`The study term ${term.id} (before your ${lastWtName}) must be Full-Time (‚â• ${credits_Ft} credits). Currently it has ${prevCr} CR.`);
                                term.courses.forEach(cid => errorCids.add(cid)); 
                            }
                        }
                    }
                }
            }

            let wt1Pos = -1, wt2Pos = -1, wt3Pos = -1;
            wtIndices.forEach(idx => {
                let term = currentSequence[idx];
                if (term.courses.some(c => c.includes('WT1'))) wt1Pos = idx;
                if (term.courses.some(c => c.includes('WT2'))) wt2Pos = idx;
                if (term.courses.some(c => c.includes('WT3'))) wt3Pos = idx;
            });
            
            if (wt1Pos > -1 && wt2Pos > -1 && wt2Pos <= wt1Pos) errors.push("Invalid Sequence: WT2 must be placed AFTER WT1.");
            if (wt2Pos > -1 && wt3Pos > -1 && wt3Pos <= wt2Pos) errors.push("Invalid Sequence: WT3 must be placed AFTER WT2.");

            let finalWtPos = Math.max(wt1Pos, wt2Pos, wt3Pos);
            if (finalWtPos > -1) {
                let hasCoreAfter = false;
                for(let i = finalWtPos + 1; i < currentSequence.length; i++) {
                    if (currentSequence[i].courses.some(id => coursesData[id] && (coursesData[id].type || "").toUpperCase().includes('CORE'))) {
                        hasCoreAfter = true; break;
                    }
                }
                if (!hasCoreAfter) errors.push("You must have at least one CORE course placed AFTER your final Work Term.");
            }
        }

        let list = document.getElementById('liveValidationList');

        let lastGpaScore = -1;
        let lastGpaVal = null;
        let progNameGpa = document.getElementById('programSelect').value.toUpperCase().replace(/\s+/g, ' ').trim();
        let gpaThreshold = programGpaThresholds[progNameGpa];
        if (gpaThreshold === undefined) gpaThreshold = 2.0;

        Object.keys(studentCGPAData).forEach(key => {
            let parts = key.split('_');
            let y = parseInt(parts[0]);
            let season = parts[1];
            let score = y * 10 + (season==='WIN'?1:(season==='SUM'?2:3)); 
            
            if (studentCGPAData[key].gpa_val !== -1 && score > lastGpaScore) {
                lastGpaScore = score;
                lastGpaVal = studentCGPAData[key].gpa_val;
            }
        });

        if (lastGpaVal !== null) {
            if (lastGpaVal <= gpaThreshold) {
                errors.push(`LOW GPA (below threshold). Your most recent GPA is ${lastGpaVal}.`);
            } else if (lastGpaVal <= gpaThreshold + 0.2) {
                errors.push(`LOW GPA - no WT for the next 2 WTs. Your most recent GPA is ${lastGpaVal}.`);
            }
        }

        list.innerHTML = '';
        errors = [...new Set(errors)];
        if (errors.length === 0) {
            list.innerHTML = `
                <li style="color:#27ae60; font-weight:bold; margin-bottom: 6px;">‚úÖ Sequence looks good! All rules implemented in this tool seem to be satisfied.</li>
                <li style="color:#333; font-weight:bold;">‚ö†Ô∏è Students are ultimately responsible for their sequences.</li>
            `;
        } else {
            errors.forEach(msg => { list.innerHTML += `<li style="color:#c0392b; margin-bottom:5px;">‚ùå ${msg}</li>`; });
        }

        let justBox = document.getElementById('justificationBox');
        let justLabel = document.getElementById('justificationLabel');
        let justText = document.getElementById('justificationText');
        
        if (justBox && justLabel && justText) {
            if (errors.length > 0) {
                justBox.style.borderLeftColor = '#c0392b';
                justBox.style.backgroundColor = '#fdf2f2';
                justLabel.style.color = '#c0392b';
                justLabel.innerHTML = '‚ö†Ô∏è <b>Warnings detected!</b> You must provide a justification below before submitting:';
                
                let currentText = justText.value.trim();
                let myJustText = "MY JUSTIFICATION:\n";
                
                if (!currentText.includes(myJustText)) {
                    let systemWarning = "SYSTEM WARNINGS:\n" + errors.map(e => "- " + e.replace(/<[^>]*>?/gm, '')).join('\n') + "\n\n";
                    justText.value = systemWarning + myJustText;
                    justText.dataset.originalText = systemWarning + myJustText;
                }
            } else {
                justBox.style.borderLeftColor = '#27ae60';
                justBox.style.backgroundColor = '#f9fff9';
                justLabel.style.color = '#27ae60';
                justLabel.innerHTML = 'üí¨ Sequence looks good! Comments are optional:';
                justText.dataset.originalText = "";
                if (justText.value.includes("SYSTEM WARNINGS:")) {
                    justText.value = "";
                }
            }
        }
    }

    async function submitSequence() {
        const justTextElement = document.getElementById('justificationText');
        let justText = justTextElement.value;
        
        const hasErrors = document.getElementById('justificationLabel').innerHTML.includes('Warning');

        let totalCoursesOnGrid = 0;
        let totalWTsOnGrid = 0;
        
        document.querySelectorAll('td .drop-zone:not(#zone_Y0_ANY)').forEach(z => {
            totalCoursesOnGrid += z.children.length;
            Array.from(z.children).forEach(el => {
                if (el.classList.contains('wt') || el.id.includes('WT')) totalWTsOnGrid++;
            });
        });
        
        if (totalCoursesOnGrid === 0) {
            alert("‚ùå Cannot submit an empty sequence! Please generate or place your courses on the grid first.");
            return;
        }
        
        let isCoop = document.getElementById('coopRegistered').checked;
        if (isCoop && totalWTsOnGrid === 0) {
            alert("‚ùå Cannot submit a CO-OP sequence without any Work Terms placed! Please place your WT courses on the grid before submitting.");
            return;
        }

        if (hasErrors) {
            let originalText = justTextElement.dataset.originalText || "";
            
            if (justText.trim() === originalText.trim()) {
                alert("‚ö†Ô∏è Your sequence has validation warnings. Please provide your justification below the 'MY JUSTIFICATION:' line before submitting.");
                justTextElement.focus();
                return;
            }

            let studentReply = justText;
            if (justText.includes("MY JUSTIFICATION:")) {
                studentReply = justText.split("MY JUSTIFICATION:")[1].trim();
            } else {
                studentReply = justText.trim();
            }

            if (studentReply.length < 5) {
                alert("‚ö†Ô∏è Please provide a more detailed justification for the warnings before submitting.");
                justTextElement.focus();
                return;
            }
            justText = justText.trim();
        } else {
            justText = justText.trim();
        }

        document.getElementById('loadingOverlay').style.display = 'flex';

        let seqData = {};
        document.querySelectorAll('td .drop-zone').forEach(z => {
            let termId = z.id.replace('zone_', '');
            seqData[termId] = Array.from(z.children).map(c => c.id);
        });

        let termSummary = [];
        let wtSummary = {};
        let pTerm = document.getElementById('startTerm').value;
        let pYear = parseInt(document.getElementById('startYear').value);
        let baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;

        for(let y=1; y<=7; y++) {
            let yearData = {};
            let hasCourses = false;
            let yearStr = `${baseYear + y - 1}-${baseYear + y}`;
            
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let termRealYear = t === 'WIN' ? baseYear + y : baseYear + y - 1;
                let zone = document.getElementById(`zone_Y${y}_${t}`);
                let cr = document.getElementById(`cr_Y${y}_${t}`) ? document.getElementById(`cr_Y${y}_${t}`).innerText : "0";
                
                let is_current_term = document.getElementById(`cont_Y${y}_${t}`) && document.getElementById(`cont_Y${y}_${t}`).classList.contains('current-term-highlight');
                let is_institute_wt = document.getElementById(`cont_Y${y}_${t}`) && document.getElementById(`cont_Y${y}_${t}`).classList.contains('institute-wt-bg');
                let is_coop = document.getElementById('coopRegistered').checked;

                yearData[t] = { cr: cr, courses: [], is_current_term: is_current_term, is_institute_wt: is_institute_wt, is_coop: is_coop };

                let cgpaInfoEmail = studentCGPAData[`${termRealYear}_${t}`];
                if (cgpaInfoEmail) {
                    yearData[t].gpa_info = {
                        val: cgpaInfoEmail.gpa_val,
                        credits: cgpaInfoEmail.credits_val,
                        cgpa: cgpaInfoEmail.cgpa,
                        tot_cr: cgpaInfoEmail.tot_cr,
                        threshold: programGpaThresholds[document.getElementById('programSelect').value.toUpperCase().replace(/\s+/g, ' ').trim()] || 2.0
                    };
                    hasCourses = true; 
                }

                if (parseFloat(cr) > 0 || zone.children.length > 0 || is_institute_wt) {
                    hasCourses = true;
                    Array.from(zone.children).forEach(el => {
                        let c = coursesData[el.id];
                        if (c) {
                            yearData[t].courses.push({ name: c.full_name, credit: c.credit, is_wt: c.is_wt });
                            if (c.is_wt) {
                                let wtCode = c.full_name; 
                                let normCode = wtCode.replace(/[^0-9]/g, ''); 
                                let wtTarget = `Study term / Other`;
                                
                                if (is_institute_wt) {
                                    let info = studentCoopData[`${termRealYear}_${t}`];
                                    if (info && info.label && info.label.toLowerCase() !== 'nan') wtTarget = info.label; 
                                }
                                
                                let changeText = "";
                                let isChange = true;
                                
                                if (wtTarget !== "Study term / Other") {
                                    let normTarget = wtTarget.replace(/[^0-9]/g, '');
                                    // VerificƒÉm dacƒÉ grila institutului coincide cu cursul
                                    if (wtTarget.toUpperCase().includes('W') && normCode === normTarget) {
                                        isChange = false; 
                                    }
                                }
                                
                                let seasonMap = {'SUM': 'Summer', 'FALL': 'Fall', 'WIN': 'Winter'};
                                
                                if (isChange) {
                                    // CƒÉutƒÉm √Æn datele institutului unde era plasat acest WT (ex: W-1) ini»õial
                                    let origTermKey = Object.keys(studentCoopData).find(k => {
                                        let lbl = studentCoopData[k].label || "";
                                        return lbl.toUpperCase().includes('W') && lbl.replace(/[^0-9]/g, '') === normCode;
                                    });
                                    
                                    if (origTermKey) {
                                        let [oYearStr, oTerm] = origTermKey.split('_'); 
                                        let oYearInt = parseInt(oYearStr);
                                        // CalculƒÉm Anul Academic corect pentru locul de unde a fost mutat
                                        let oAcaYearStr = (oTerm === 'WIN') ? `${oYearInt-1}-${oYearInt}` : `${oYearInt}-${oYearInt+1}`;
                                        
                                        changeText = `moved from ${oAcaYearStr} ${seasonMap[oTerm]}`;
                                    } else {
                                        changeText = `placed outside original schedule`;
                                    }
                                }
                                
                                yearData[t].wt_change = changeText;
                                
                                wtSummary[wtCode] = {
                                    new_term: `${yearStr} ${seasonMap[t]}`, // SetƒÉm »ôi destina»õia tot √Æn formatul an academic
                                    change_text: changeText
                                };
                            }
                        }
                    });
                }
            });
            if (hasCourses) {
                termSummary.push({ year: yearStr, data: yearData });
            }
        }

        let currentSid = "";
        let studentName = "";
        let displayViewingSid = document.getElementById('displayViewingSid');
        if (displayViewingSid) {
            let parts = displayViewingSid.innerText.split('-');
            currentSid = parts[0].trim();
            if (parts.length > 1) studentName = parts[1].trim();
        }

        let valErrorHTMLs = Array.from(document.querySelectorAll('#liveValidationList li')).map(li => li.innerHTML);

        let payload = {
            name: "Submitted on " + new Date().toISOString().split('T')[0],
            program: document.getElementById('programSelect').value,
            student_id: currentSid,
            student_name: studentName, 
            sequence_data: seqData,
            term_data: {}, 
            settings_data: {
                startYear: document.getElementById('startYear').value,
                coop: document.getElementById('coopRegistered').checked
            },
            status: "PENDING APPROVAL",
            justification: justText, 
            student_comments: "",    
            wt_summary: wtSummary,       
            term_summary: termSummary,
            validation_errors: valErrorHTMLs
        };

        try {
            const res = await fetch('/save_sequence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            document.getElementById('loadingOverlay').style.display = 'none';
            if (res.ok) {
                alert("‚úÖ Sequence successfully submitted for approval! An email notification has been sent.");
                window.location.reload();
            } else {
                alert("‚ùå Error submitting sequence. Please try again.");
            }
        } catch (e) {
            document.getElementById('loadingOverlay').style.display = 'none';
            console.error(e);
            alert("Connection error.");
        }
    }

    async function processStatusAction(status) {
        let currentSid = "";
        let studentName = "";
        let displayViewingSid = document.getElementById('displayViewingSid');
        if (displayViewingSid) {
            let parts = displayViewingSid.innerText.split('-');
            currentSid = parts[0].trim();
            if (parts.length > 1) studentName = parts[1].trim();
        }

        const program = document.getElementById('programSelect').value;
        const pubComment = document.getElementById('publicComments').value;
        const privComment = document.getElementById('privateComments').value;
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        let termSummary = [];
        let wtSummary = {};
        let pTerm = document.getElementById('startTerm').value;
        let pYear = parseInt(document.getElementById('startYear').value);
        let baseYear = pTerm === 'Winter' ? pYear - 1 : pYear;

        for(let y=1; y<=7; y++) {
            let yearData = {};
            let hasCourses = false;
            let yearStr = `${baseYear + y - 1}-${baseYear + y}`;
            
            ['SUM', 'FALL', 'WIN'].forEach(t => {
                let termRealYear = t === 'WIN' ? baseYear + y : baseYear + y - 1;
                let zone = document.getElementById(`zone_Y${y}_${t}`);
                let cr = document.getElementById(`cr_Y${y}_${t}`) ? document.getElementById(`cr_Y${y}_${t}`).innerText : "0";
                
                let is_current_term = document.getElementById(`cont_Y${y}_${t}`) && document.getElementById(`cont_Y${y}_${t}`).classList.contains('current-term-highlight');
                let is_institute_wt = document.getElementById(`cont_Y${y}_${t}`) && document.getElementById(`cont_Y${y}_${t}`).classList.contains('institute-wt-bg');
                let is_coop = document.getElementById('coopRegistered').checked;

                yearData[t] = { cr: cr, courses: [], is_current_term: is_current_term, is_institute_wt: is_institute_wt, is_coop: is_coop };

                let cgpaInfoEmail = studentCGPAData[`${termRealYear}_${t}`];
                if (cgpaInfoEmail) {
                    yearData[t].gpa_info = {
                        val: cgpaInfoEmail.gpa_val,
                        credits: cgpaInfoEmail.credits_val,
                        cgpa: cgpaInfoEmail.cgpa,
                        tot_cr: cgpaInfoEmail.tot_cr,
                        threshold: programGpaThresholds[document.getElementById('programSelect').value.toUpperCase().replace(/\s+/g, ' ').trim()] || 2.0
                    };
                    hasCourses = true; 
                }

                if (parseFloat(cr) > 0 || zone.children.length > 0 || is_institute_wt) {
                    hasCourses = true;
                    Array.from(zone.children).forEach(el => {
                        let c = coursesData[el.id];
                        if (c) {
                            yearData[t].courses.push({ name: c.full_name, credit: c.credit, is_wt: c.is_wt });
                            if (c.is_wt) {
                                let wtCode = c.full_name; 
                                let normCode = wtCode.replace(/[^0-9]/g, ''); 
                                let wtTarget = `Study term / Other`;
                                
                                if (is_institute_wt) {
                                    let info = studentCoopData[`${termRealYear}_${t}`];
                                    if (info && info.label && info.label.toLowerCase() !== 'nan') wtTarget = info.label; 
                                }
                                
                                let changeText = "";
                                let isChange = true;
                                
                                if (wtTarget !== "Study term / Other") {
                                    let normTarget = wtTarget.replace(/[^0-9]/g, '');
                                    // VerificƒÉm dacƒÉ grila institutului coincide cu cursul
                                    if (wtTarget.toUpperCase().includes('W') && normCode === normTarget) {
                                        isChange = false; 
                                    }
                                }
                                
                                let seasonMap = {'SUM': 'Summer', 'FALL': 'Fall', 'WIN': 'Winter'};
                                
                                if (isChange) {
                                    // CƒÉutƒÉm √Æn datele institutului unde era plasat acest WT (ex: W-1) ini»õial
                                    let origTermKey = Object.keys(studentCoopData).find(k => {
                                        let lbl = studentCoopData[k].label || "";
                                        return lbl.toUpperCase().includes('W') && lbl.replace(/[^0-9]/g, '') === normCode;
                                    });
                                    
                                    if (origTermKey) {
                                        let [oYearStr, oTerm] = origTermKey.split('_'); 
                                        let oYearInt = parseInt(oYearStr);
                                        // CalculƒÉm Anul Academic corect pentru locul de unde a fost mutat
                                        let oAcaYearStr = (oTerm === 'WIN') ? `${oYearInt-1}-${oYearInt}` : `${oYearInt}-${oYearInt+1}`;
                                        
                                        changeText = `moved from ${oAcaYearStr} ${seasonMap[oTerm]}`;
                                    } else {
                                        changeText = `placed outside original schedule`;
                                    }
                                }
                                
                                yearData[t].wt_change = changeText;
                                
                                wtSummary[wtCode] = {
                                    new_term: `${yearStr} ${seasonMap[t]}`, // SetƒÉm »ôi destina»õia tot √Æn formatul an academic
                                    change_text: changeText
                                };
                            }
                        }
                    });
                }
            });
            if (hasCourses) {
                termSummary.push({ year: yearStr, data: yearData });
            }
        }

        let valErrorHTMLs = Array.from(document.querySelectorAll('#liveValidationList li')).map(li => li.innerHTML);

        try {
            const res = await fetch('/update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: status,
                    student_id: currentSid,
                    student_name: studentName,
                    program: program,
                    timestamp: windowLoadedSeqTimestamp,
                    original_title: windowLoadedSeqTitle,
                    row_index: windowLoadedSeqRowIndex,
                    submitter_email: windowLoadedSeqEmail, 
                    public_comments: pubComment,
                    private_comments: privComment,
                    wt_summary: wtSummary,
                    term_summary: termSummary,
                    validation_errors: valErrorHTMLs
                })
            });
            
            let result = await res.json();
            document.getElementById('loadingOverlay').style.display = 'none';
            
            if (res.ok) {
                alert(`Sequence ${status}! Email sent.`);
                window.location.reload();
            } else {
                alert("Error updating status: " + (result.error || "Unknown error"));
            }
        } catch (e) {
            document.getElementById('loadingOverlay').style.display = 'none';
            console.error(e);
            alert("Connection error !");
        }
    }

    // AdaugƒÉ parametrul forceRefresh
    async function openPendingModal(forceRefresh = false) {
        const modal = document.getElementById('pendingModal');
        const ul = document.getElementById('pendingListUl');
        ul.innerHTML = '<li>Loading...</li>';
        modal.style.display = 'block';

        try {
            let url = '/api/pending_approvals';
            if (forceRefresh) url += '?refresh=true'; // NOU
            
            const res = await fetch(url);
            // ... restul codului rƒÉm√¢ne la fel
            if(res.ok) {
                currentPendingList = await res.json();
                ul.innerHTML = '';
                if(currentPendingList.length === 0) {
                    ul.innerHTML = '<li>No pending sequences found.</li>';
                } else {
                    currentPendingList.forEach((item, index) => {
                        let li = document.createElement('li');
                        li.style.padding = '10px';
                        li.style.borderBottom = '1px solid #eee';
                        li.style.cursor = 'pointer';
                        li.innerHTML = `<strong>${item.student_id}</strong> - ${item.program}<br><span style="font-size:11px; color:#777;">${item.timestamp}</span>`;
                        li.onclick = () => loadPendingSequence(index);
                        ul.appendChild(li);
                    });
                }
            }
        } catch(e) {
            ul.innerHTML = '<li>Error loading pending sequences.</li>';
        }
    }

    async function loadPendingSequence(index) {
        if(index < 0 || index >= currentPendingList.length) return;
        
        const fullData = currentPendingList[index];
        
        let seqObj = {};
        let termObj = {};
        let settObj = {};
        
        try { seqObj = typeof fullData.sequence_data === 'string' ? JSON.parse(fullData.sequence_data) : fullData.sequence_data; } catch(e){}
        try { termObj = typeof fullData.term_data === 'string' ? JSON.parse(fullData.term_data) : fullData.term_data; } catch(e){}
        try { settObj = typeof fullData.settings_data === 'string' ? JSON.parse(fullData.settings_data) : fullData.settings_data; } catch(e){}

        windowLoadedSeqTimestamp = fullData.timestamp;
        windowLoadedSeqTitle = fullData.name;
        windowLoadedSeqRowIndex = fullData.row_index;
        windowLoadedSeqEmail = fullData.email;

        let displaySidEl = document.getElementById('displayViewingSid');
        if (displaySidEl) {
            displaySidEl.innerText = fullData.student_name ? `${fullData.student_id} - ${fullData.student_name}` : fullData.student_id;
        }
        
        // --- NOU: ActualizƒÉm »ôi cƒÉsu»õa de Admin Input pentru a nu se √Æncurca ---
        let adminInput = document.getElementById('adminSidInput');
        if (adminInput) {
            adminInput.value = fullData.student_id ? fullData.student_id.toString().split('-')[0].trim() : "";
        }
        // ----------------------------------------------------------------------
        
        let safeSid = fullData.student_id ? fullData.student_id.toString().split('-')[0].trim() : "";
        
        if (safeSid && safeSid !== "ADMIN") {
            await fetchAndUpdateCoopData(safeSid); 
            await fetchCGPAData(safeSid); 
            fetchComments(safeSid);
        } else {
            studentCoopData = {};
            studentCGPAData = {}; 
        }

        await loadSequenceData(seqObj, termObj, settObj, fullData.program);
        document.getElementById('pendingModal').style.display = 'none';
        
        document.getElementById('btnApprove').style.display = 'inline-block';
        document.getElementById('btnRework').style.display = 'inline-block';
        
        let justText = document.getElementById('justificationText');
        if(justText) {
            justText.value = fullData.justification || "";
            if(fullData.justification) {
                document.getElementById('justificationBox').style.display = 'block';
            }
        }
    }

    function updateRoutingInfo() {
        let prog = document.getElementById('programSelect').value.toUpperCase();
        let sid = document.getElementById('displayViewingSid') ? document.getElementById('displayViewingSid').innerText.split('-')[0].trim() : "";
        
        let coordName = "Frederick Francis";
        let coordEmail = "frederick.francis@concordia.ca";
        
        if (prog.includes('INDU')) {
            coordName = "Nadia Mazzaferro";
            coordEmail = "nadia.mazzaferro@concordia.ca";
        } else if (sid) {
            let lastDigit = parseInt(sid.slice(-1));
            if (!isNaN(lastDigit)) {
                if (lastDigit >= 5 && lastDigit <= 9) {
                    coordName = "Nathalie Steverman";
                    coordEmail = "nathalie.steverman@concordia.ca";
                }
            }
        }
        
        let spanName = document.getElementById('coopCoordName');
        let spanEmail = document.getElementById('coopCoordEmail');
        if(spanName) spanName.innerText = coordName;
        if(spanEmail) spanEmail.innerText = coordEmail;
    }

    function fetchComments(sid) {
        if (!sid) return;
        fetch('/get_comments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: sid })
        })
        .then(r => r.json())
        .then(data => {
            let pubEl = document.getElementById('publicComments');
            let privEl = document.getElementById('privateComments');
            if (pubEl) {
                pubEl.value = data.public || "";
                pubEl.style.height = ''; 
                pubEl.style.height = pubEl.scrollHeight + 'px';
            }
            if (privEl) {
                privEl.value = data.private || "";
                privEl.style.height = ''; 
                privEl.style.height = privEl.scrollHeight + 'px';
            }
        })
        .catch(e => console.log("Failed to fetch comments"));
    }

    async function fetchAndUpdateCoopData(sid) {
        try {
            const res = await fetch('/api/get_coop_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: sid })
            });
            const data = await res.json();
            
            if (data.found) {
                studentCoopData = data.terms;
                
                if (data.admission) {
                    let sYearSelect = document.getElementById('startYear');
                    if(!Array.from(sYearSelect.options).some(o => o.value == data.admission.year)) {
                        sYearSelect.add(new Option(data.admission.year, data.admission.year));
                    }
                    sYearSelect.value = data.admission.year;
                    document.getElementById('startTerm').value = data.admission.term.includes('FALL') ? "Fall" : "Winter";
                    
                    document.getElementById('coopRegistered').checked = true;
                    updateCoopYears();
                    document.getElementById('coopStartYear').value = data.admission.year;
                    document.getElementById('coopStartTerm').value = "FALL";
                }
            } else {
                studentCoopData = {};
            }
            injectCoopHeaders();
        } catch (e) {
            console.error("Failed to fetch COOP data:", e);
            studentCoopData = {};
        }
    }

    async function fetchCGPAData(sid) {
        try {
            const res = await fetch('/api/get_cgpa_timeline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: sid })
            });
            const data = await res.json();
            
            studentCGPAData = {};
            Object.keys(data).forEach(rawTerm => {
                let yearMatch = rawTerm.match(/(\d{4})-(\d{4})/);
                if (yearMatch) {
                    let startYear = parseInt(yearMatch[1]);
                    let endYear = parseInt(yearMatch[2]);
                    let season = "";
                    let rawUp = rawTerm.toUpperCase();
                    
                    if (rawUp.includes('FALL')) season = 'FALL';
                    else if (rawUp.includes('WIN')) season = 'WIN';
                    else if (rawUp.includes('SUM')) season = 'SUM';
                    
                    if (season) {
                        let realYear = (season === 'WIN') ? endYear : startYear;
                        studentCGPAData[`${realYear}_${season}`] = data[rawTerm];
                    }
                }
            });
        } catch (e) {
            console.error("Failed to fetch CGPA data:", e);
            studentCGPAData = {};
        }
    }

    async function autoSaveComments(element) {
        let currentSid = "";
        let displayViewingSid = document.getElementById('displayViewingSid');
        if (displayViewingSid) currentSid = displayViewingSid.innerText.split('-')[0].trim();
        if (!currentSid || currentSid === "ADMIN") return;

        let pubEl = document.getElementById('publicComments');
        let privEl = document.getElementById('privateComments');
        
        let pubComment = pubEl ? pubEl.value : "";
        let privComment = privEl ? privEl.value : "";

        let originalBg = element.style.background;
        
        try {
            const res = await fetch('/save_comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: currentSid,
                    public_comments: pubComment,
                    private_comments: privComment
                })
            });
            
            const result = await res.json();
            if (result.success) {
                element.style.background = '#e8f8f5'; 
                setTimeout(() => { element.style.background = originalBg; }, 800);
            }
        } catch (e) {
            console.error("Auto-save comments failed:", e);
        }
    }

    async function autoDetectProgram() {
        let currentSid = "";
        let displaySid = document.getElementById('displayViewingSid');
        if (displaySid) {
            currentSid = displaySid.innerText.split('-')[0].trim();
        }
        if (!currentSid || currentSid === "ADMIN") return;

        fetchComments(currentSid);
        await fetchAndUpdateCoopData(currentSid); 
        await fetchCGPAData(currentSid);          

        try {
            document.getElementById('loadingOverlay').style.display = 'flex';
            const res = await fetch('/get_transcript', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({student_id: currentSid})
            });
            const data = await res.json();
            
            if (data.suggested_program) {
                let progSelect = document.getElementById('programSelect');
                let exists = Array.from(progSelect.options).some(o => o.value.toUpperCase().includes(data.suggested_program));
                
                if (exists) {
                    let match = Array.from(progSelect.options).find(o => o.value.toUpperCase().includes(data.suggested_program));
                    if (match && progSelect.value !== match.value) {
                        progSelect.value = match.value;
                        await progSelect.onchange(); 
                    }
                }
            }
        } catch(e) {
            console.error("Eroare autodetectare program:", e);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    autoDetectProgram();

</script>
</body>
</html>